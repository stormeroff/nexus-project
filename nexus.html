<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MEDIAPIPE NEXUS</title>

<!--
  MEDIAPIPE TASKS-VISION
  Utilisation d'un importmap + <script type="module">
  C'est la seule m√©thode officiellement support√©e par le package.
  Fonctionne sur localhost (http) et HTTPS ‚Äî pas sur file://.
-->
<script type="importmap">
{
  "imports": {
    "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/+esm"
  }
}
</script>
<script type="module">
  window._mpClasses = null;
  window._mpLoadDone = false;
  const CDNs = [
    () => import('@mediapipe/tasks-vision'),
    () => import('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/+esm'),
    () => import('https://esm.sh/@mediapipe/tasks-vision@0.10.14'),
  ];
  for (const load of CDNs) {
    try {
      const mp = await load();
      const ns = mp?.FaceLandmarker ? mp : mp?.default?.FaceLandmarker ? mp.default : null;
      if (ns) { window._mpClasses = ns; console.log('‚úÖ MediaPipe ESM OK'); break; }
    } catch(e) { console.warn('CDN √©chou√©:', e.message); }
  }
  window._mpLoadDone = true;
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Exo+2:wght@300;400;600&display=swap');

:root {
  --neon-cyan: #00f5ff;
  --neon-pink: #ff006e;
  --neon-green: #39ff14;
  --neon-yellow: #ffe000;
  --dark-bg: #020408;
  --panel-bg: rgba(0,20,35,0.85);
  --border-glow: rgba(0,245,255,0.3);
  --text-primary: #e0f7fa;
  --text-dim: #4a7f8a;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--dark-bg);
  color: var(--text-primary);
  font-family: 'Exo 2', sans-serif;
  min-height: 100vh;
  overflow: hidden;
}

body::before {
  content:'';
  position:fixed; inset:0;
  background-image: 
    linear-gradient(rgba(0,245,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,245,255,0.03) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events:none; z-index:0;
}

body::after {
  content:'';
  position:fixed; inset:0;
  background: repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.1) 2px,rgba(0,0,0,0.1) 4px);
  pointer-events:none; z-index:999;
}

/* LOADING */
#loadingOverlay {
  position:fixed; inset:0;
  background:var(--dark-bg);
  z-index:9999;
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px;
  transition: opacity 0.6s;
}
#loadingOverlay.hidden { opacity:0; pointer-events:none; }
.loading-logo {
  font-family:'Orbitron',monospace; font-size:32px; font-weight:900;
  background: linear-gradient(90deg, var(--neon-cyan), var(--neon-pink));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  letter-spacing:5px; animation: loadPulse 1s ease-in-out infinite;
}
@keyframes loadPulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
.loading-bar-wrap { width:320px; height:2px; background:rgba(0,245,255,0.1); overflow:hidden; }
.loading-bar { height:100%; background:linear-gradient(90deg,var(--neon-cyan),var(--neon-pink)); width:0%; transition:width 0.3s; }
.loading-text { font-family:'Share Tech Mono'; font-size:11px; color:var(--text-dim); letter-spacing:3px; }
.loading-status { font-family:'Share Tech Mono'; font-size:10px; color:var(--neon-cyan); }

/* HEADER */
header {
  position:relative; z-index:10;
  padding:14px 30px;
  display:flex; align-items:center; justify-content:space-between;
  border-bottom:1px solid var(--border-glow);
  background:rgba(0,5,15,0.95);
  height:62px;
}
.logo { display:flex; align-items:center; gap:12px; }
.logo-icon {
  width:42px; height:42px;
  border:2px solid var(--neon-cyan); border-radius:6px;
  display:grid; place-items:center;
  box-shadow:0 0 20px rgba(0,245,255,0.4);
  animation:iconPulse 3s ease-in-out infinite;
  font-size:20px;
}
@keyframes iconPulse { 0%,100%{box-shadow:0 0 20px rgba(0,245,255,0.4)} 50%{box-shadow:0 0 40px rgba(0,245,255,0.8)} }
.logo-text { font-family:'Orbitron',monospace; font-size:22px; font-weight:900; letter-spacing:3px; background:linear-gradient(90deg,var(--neon-cyan),var(--neon-pink)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.logo-sub { font-family:'Share Tech Mono'; font-size:9px; color:var(--text-dim); letter-spacing:3px; margin-top:2px; }
.header-status { display:flex; align-items:center; gap:16px; font-family:'Share Tech Mono'; font-size:10px; color:var(--text-dim); }
.status-dot { width:7px; height:7px; border-radius:50%; background:var(--neon-green); box-shadow:0 0 8px var(--neon-green); animation:blink 2s ease-in-out infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }
#mpStatus { color:var(--neon-yellow); }
#mpStatus.ready { color:var(--neon-green); }

/* LAYOUT */
.app-layout { display:flex; height:calc(100vh - 62px); position:relative; z-index:1; }

/* SIDEBAR */
.sidebar {
  width:268px; min-width:268px;
  background:rgba(0,8,18,0.97);
  border-right:1px solid var(--border-glow);
  display:flex; flex-direction:column;
  overflow-y:auto; overflow-x:hidden;
}
.sidebar::-webkit-scrollbar { width:3px; }
.sidebar::-webkit-scrollbar-thumb { background:rgba(0,245,255,0.2); }

.cat-btn {
  padding:0; border:none; background:none; cursor:pointer; width:100%; text-align:left;
}
.cat-header {
  padding:14px 18px 10px;
  border-bottom:1px solid rgba(0,245,255,0.08);
  transition:all 0.3s; position:relative; overflow:hidden;
}
.cat-header::before {
  content:''; position:absolute; left:0; top:0; bottom:0; width:3px;
  background:var(--cat-color,var(--neon-cyan)); opacity:0; transition:opacity 0.3s;
  box-shadow:0 0 10px var(--cat-color,var(--neon-cyan));
}
.cat-header.active::before { opacity:1; }
.cat-header.active { background:rgba(0,245,255,0.04); }
.cat-title {
  font-family:'Orbitron',monospace; font-size:10px; font-weight:700; letter-spacing:2px;
  color:var(--cat-color,var(--neon-cyan)); display:flex; align-items:center; gap:8px;
}
.cat-count { margin-left:auto; background:rgba(0,245,255,0.1); border:1px solid var(--border-glow); padding:1px 7px; border-radius:20px; font-size:9px; color:var(--text-dim); }
.cat-desc { font-size:9px; color:var(--text-dim); margin-top:3px; font-family:'Share Tech Mono'; }

.feat-list { display:none; flex-direction:column; }
.feat-list.open { display:flex; }

.feat-item {
  padding:8px 18px 8px 28px; font-size:11px; cursor:pointer;
  color:var(--text-dim); transition:all 0.2s; border:none; background:none;
  text-align:left; font-family:'Exo 2'; display:flex; align-items:center; gap:6px;
  border-bottom:1px solid rgba(0,245,255,0.03);
}
.feat-item:hover, .feat-item.active { color:var(--text-primary); background:rgba(0,245,255,0.04); padding-left:32px; }
.feat-item.active { color:var(--neon-cyan); border-left:2px solid var(--neon-cyan); }

.feat-badge {
  margin-left:auto; font-size:8px; padding:1px 5px; border:1px solid;
  border-radius:2px; font-family:'Share Tech Mono';
}
.badge-live { border-color:var(--neon-green); color:var(--neon-green); }
.badge-demo { border-color:var(--neon-yellow); color:var(--neon-yellow); }

/* MAIN */
.main-content { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.breadcrumb {
  padding:9px 24px; font-family:'Share Tech Mono'; font-size:10px; color:var(--text-dim);
  border-bottom:1px solid rgba(0,245,255,0.06); background:rgba(0,5,15,0.6);
  display:flex; align-items:center; gap:6px; height:34px;
}
.breadcrumb span { color:var(--neon-cyan); }

.content-area { flex:1; display:flex; overflow:hidden; }

/* PANELS */
.feat-panel { display:none; width:100%; height:100%; }
.feat-panel.active { display:flex; }

/* HOME */
.home-wrap {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  padding:30px; gap:30px; overflow-y:auto;
}
.home-title {
  font-family:'Orbitron',monospace; font-size:40px; font-weight:900; text-align:center;
  background:linear-gradient(135deg,var(--neon-cyan) 0%,var(--neon-pink) 50%,var(--neon-yellow) 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  animation:titleGlow 4s ease-in-out infinite;
}
@keyframes titleGlow { 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.3)} }
.home-sub { font-family:'Share Tech Mono'; font-size:12px; color:var(--text-dim); letter-spacing:3px; text-align:center; }

.cat-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; width:100%; max-width:820px; }
.cat-card {
  border:1px solid; padding:22px 18px; cursor:pointer; transition:all 0.3s;
  position:relative; overflow:hidden; background:rgba(0,10,20,0.6);
}
.cat-card::before {
  content:''; position:absolute; inset:0;
  background:radial-gradient(circle at 50% 0%, var(--cc) 0%, transparent 70%);
  opacity:0; transition:opacity 0.3s;
}
.cat-card:hover::before { opacity:0.15; }
.cat-card:hover { transform:translateY(-4px); }
.cat-card-0 { border-color:rgba(0,245,255,0.3); --cc:var(--neon-cyan); }
.cat-card-1 { border-color:rgba(255,0,110,0.3); --cc:var(--neon-pink); }
.cat-card-2 { border-color:rgba(57,255,20,0.3); --cc:var(--neon-green); }
.cat-card:hover.cat-card-0 { border-color:var(--neon-cyan); box-shadow:0 8px 30px rgba(0,245,255,0.2); }
.cat-card:hover.cat-card-1 { border-color:var(--neon-pink); box-shadow:0 8px 30px rgba(255,0,110,0.2); }
.cat-card:hover.cat-card-2 { border-color:var(--neon-green); box-shadow:0 8px 30px rgba(57,255,20,0.2); }
.cat-card-em { font-size:34px; margin-bottom:10px; display:block; }
.cat-card-nm { font-family:'Orbitron',monospace; font-size:11px; font-weight:700; letter-spacing:2px; margin-bottom:6px; }
.cat-card-0 .cat-card-nm { color:var(--neon-cyan); }
.cat-card-1 .cat-card-nm { color:var(--neon-pink); }
.cat-card-2 .cat-card-nm { color:var(--neon-green); }
.cat-card-ft { font-size:10px; color:var(--text-dim); font-family:'Share Tech Mono'; line-height:1.9; }

/* CAM PANEL */
.cam-panel {
  flex:1; display:flex; flex-direction:column; padding:18px 22px;
  overflow-y:auto; gap:12px;
}
.feat-hdr { display:flex; align-items:center; gap:10px; flex-shrink:0; }
.feat-em { font-size:20px; }
.feat-nm { font-family:'Orbitron',monospace; font-size:13px; font-weight:700; color:var(--neon-cyan); letter-spacing:2px; }
.tag { font-family:'Share Tech Mono'; font-size:8px; padding:2px 8px; border:1px solid; border-radius:2px; letter-spacing:1px; }
.tag-live { border-color:var(--neon-green); color:var(--neon-green); }
.tag-demo { border-color:var(--neon-yellow); color:var(--neon-yellow); }
.tag-beta { border-color:var(--neon-pink); color:var(--neon-pink); }

.cam-frame {
  position:relative; width:100%; flex-shrink:0;
  aspect-ratio:4/3; max-height:360px; max-width:480px;
  align-self:center;
}
.cam-frame::before,.cam-frame::after {
  content:''; position:absolute; width:24px; height:24px;
  border-color:var(--neon-cyan); border-style:solid; z-index:5;
}
.cam-frame::before { top:-1px; left:-1px; border-width:2px 0 0 2px; }
.cam-frame::after  { bottom:-1px; right:-1px; border-width:0 2px 2px 0; }
.cam-corner-bl { position:absolute; bottom:-1px; left:-1px; width:24px; height:24px; border:2px solid var(--neon-cyan); border-width:0 0 2px 2px; z-index:5; }
.cam-corner-tr { position:absolute; top:-1px; right:-1px; width:24px; height:24px; border:2px solid var(--neon-cyan); border-width:2px 2px 0 0; z-index:5; }

.cam-box {
  width:100%; height:100%;
  background:#000; border:1px solid rgba(0,245,255,0.2);
  position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center;
}
.cam-box video {
  position:absolute; inset:0; width:100%; height:100%;
  object-fit:cover; transform:scaleX(-1); display:none;
}
.cam-box canvas {
  position:absolute; inset:0; width:100%; height:100%;
  transform:scaleX(-1); display:none; z-index:2;
}
.cam-box video.active, .cam-box canvas.active { display:block; }

.cam-placeholder {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:10px; color:var(--text-dim); font-family:'Share Tech Mono'; font-size:11px;
  background:linear-gradient(135deg,#000a15,#001525); width:100%; height:100%;
}
.ph-icon { font-size:36px; opacity:0.5; }

.cam-controls { display:flex; gap:10px; flex-wrap:wrap; flex-shrink:0; }
.btn {
  font-family:'Orbitron',monospace; font-size:10px; font-weight:700; letter-spacing:2px;
  padding:9px 18px; border:1px solid; cursor:pointer; transition:all 0.2s;
  text-transform:uppercase; background:transparent; position:relative; overflow:hidden;
}
.btn::before { content:''; position:absolute; inset:0; background:currentColor; opacity:0; transition:opacity 0.2s; }
.btn:hover::before { opacity:0.1; }
.btn-start { border-color:var(--neon-cyan); color:var(--neon-cyan); }
.btn-start:hover { box-shadow:0 0 25px rgba(0,245,255,0.4); }
.btn-start:disabled { opacity:0.4; cursor:not-allowed; }
.btn-stop { border-color:var(--neon-pink); color:var(--neon-pink); }
.btn-stop:hover { box-shadow:0 0 20px rgba(255,0,110,0.3); }
.btn-sim { border-color:var(--neon-green); color:var(--neon-green); }
.btn-sim:hover { box-shadow:0 0 20px rgba(57,255,20,0.3); }
.btn-sm { padding:6px 12px; font-size:9px; }
.btn-yellow { border-color:var(--neon-yellow); color:var(--neon-yellow); }

.info-box {
  background:rgba(0,245,255,0.04); border:1px solid rgba(0,245,255,0.15);
  padding:10px 14px; font-family:'Share Tech Mono'; font-size:10px; color:var(--text-dim);
  line-height:1.9; flex-shrink:0;
}

/* METRICS PANEL */
.met-panel {
  width:280px; min-width:280px; background:rgba(0,6,16,0.97);
  border-left:1px solid var(--border-glow); padding:16px;
  overflow-y:auto; display:flex; flex-direction:column; gap:12px;
}
.met-panel::-webkit-scrollbar { width:3px; }
.met-panel::-webkit-scrollbar-thumb { background:rgba(0,245,255,0.2); }
.met-title { font-family:'Orbitron',monospace; font-size:9px; font-weight:700; letter-spacing:3px; color:var(--text-dim); padding-bottom:8px; border-bottom:1px solid rgba(0,245,255,0.1); }

.met-card {
  background:rgba(0,18,32,0.7); border:1px solid rgba(0,245,255,0.12);
  padding:12px; transition:border-color 0.3s;
}
.met-card:hover { border-color:rgba(0,245,255,0.35); }
.met-lbl { font-family:'Share Tech Mono'; font-size:9px; letter-spacing:2px; color:var(--text-dim); text-transform:uppercase; margin-bottom:5px; }
.met-val { font-family:'Orbitron',monospace; font-size:22px; font-weight:700; color:var(--neon-cyan); line-height:1; }
.met-unit { font-size:10px; color:var(--text-dim); margin-top:2px; font-family:'Share Tech Mono'; }
.met-bar { margin-top:8px; height:2px; background:rgba(0,245,255,0.08); position:relative; overflow:hidden; }
.met-bar-fill { height:100%; background:linear-gradient(90deg,var(--neon-cyan),var(--neon-pink)); transition:width 0.4s ease; }

.alert-box {
  padding:9px 12px; border-left:3px solid; font-size:10px; font-family:'Share Tech Mono';
  line-height:1.7; display:none;
}
.alert-box.show { display:block; }
.alert-warn { border-color:var(--neon-yellow); color:var(--neon-yellow); background:rgba(255,224,0,0.05); }
.alert-danger { border-color:var(--neon-pink); color:var(--neon-pink); background:rgba(255,0,110,0.05); }
.alert-ok { border-color:var(--neon-green); color:var(--neon-green); background:rgba(57,255,20,0.05); }

.toggle-row { display:flex; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,245,255,0.05); font-family:'Share Tech Mono'; font-size:10px; color:var(--text-dim); }
.tog { width:34px; height:17px; background:rgba(0,245,255,0.08); border:1px solid rgba(0,245,255,0.15); border-radius:8px; position:relative; cursor:pointer; transition:all 0.3s; }
.tog.on { background:rgba(0,245,255,0.25); border-color:var(--neon-cyan); }
.tog::after { content:''; position:absolute; width:11px; height:11px; border-radius:50%; background:var(--text-dim); top:2px; left:2px; transition:all 0.3s; }
.tog.on::after { left:19px; background:var(--neon-cyan); }

/* REP COUNTER */
.rep-big { font-family:'Orbitron',monospace; font-size:64px; font-weight:900; color:var(--neon-green); text-shadow:0 0 30px rgba(57,255,20,0.4); text-align:center; line-height:1; }
.rep-big.bump { animation:repBump 0.25s ease; }
@keyframes repBump { 0%{transform:scale(1)} 50%{transform:scale(1.25);color:white} 100%{transform:scale(1)} }

/* EMOTION CHIPS */
.emo-grid { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
.emo-chip { padding:3px 10px; border:1px solid rgba(255,255,255,0.1); font-family:'Share Tech Mono'; font-size:9px; color:var(--text-dim); border-radius:2px; transition:all 0.3s; }
.emo-chip.on { background:rgba(0,245,255,0.12); border-color:var(--neon-cyan); color:var(--neon-cyan); box-shadow:0 0 8px rgba(0,245,255,0.2); }

/* PAINT CANVAS */
#paintCanvas { cursor:crosshair; }

/* AR ITEM */
.ar-item-overlay {
  position:absolute; pointer-events:none;
  font-size:52px; z-index:10;
  transition:all 0.1s;
  text-shadow:0 0 20px rgba(0,245,255,0.8);
  transform-origin:center;
}

/* LANDMARK DOTS */
.lm-dot {
  position:absolute; width:6px; height:6px; border-radius:50%;
  background:var(--neon-cyan); box-shadow:0 0 6px var(--neon-cyan);
  transform:translate(-50%,-50%); pointer-events:none; z-index:5;
}

/* TOAST */
.toast {
  position:fixed; top:80px; right:24px;
  background:rgba(0,18,32,0.97); border:1px solid var(--neon-cyan); border-left:3px solid var(--neon-cyan);
  padding:10px 16px; font-family:'Share Tech Mono'; font-size:11px; color:var(--neon-cyan); z-index:10000;
  transform:translateX(120%); transition:transform 0.35s cubic-bezier(.175,.885,.32,1.275);
  max-width:260px; line-height:1.5;
}
.toast.show { transform:translateX(0); }
.toast.pink { border-color:var(--neon-pink); color:var(--neon-pink); }
.toast.green { border-color:var(--neon-green); color:var(--neon-green); }
.toast.yellow { border-color:var(--neon-yellow); color:var(--neon-yellow); }

/* POSE LINE */
.pose-overlay { position:absolute; inset:0; pointer-events:none; z-index:5; }

/* KEYBOARD VIRTUAL */
.vkb-container {
  position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
  display:flex; flex-direction:column; gap:4px; z-index:10; pointer-events:none;
}
.vkb-row { display:flex; gap:4px; justify-content:center; }
.vkb-key {
  width:28px; height:28px; border:1px solid rgba(0,245,255,0.4);
  background:rgba(0,245,255,0.05); display:grid; place-items:center;
  font-family:'Share Tech Mono'; font-size:9px; color:var(--neon-cyan);
  transition:all 0.1s;
}
.vkb-key.pressed { background:rgba(0,245,255,0.3); box-shadow:0 0 12px var(--neon-cyan); }

/* DJ mixer */
.dj-mix { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
.dj-slider-row { display:flex; align-items:center; gap:10px; font-family:'Share Tech Mono'; font-size:10px; color:var(--text-dim); }
.dj-slider-row span { width:60px; }
.dj-bar { flex:1; height:4px; background:rgba(0,245,255,0.1); position:relative; }
.dj-bar-fill { height:100%; background:linear-gradient(90deg,var(--neon-cyan),var(--neon-pink)); transition:width 0.2s; }

/* Light paint */
#lightPaintCanvas { position:absolute; inset:0; width:100%; height:100%; z-index:3; pointer-events:none; }

/* Hologram UI */
.holo-overlay {
  position:absolute; inset:0; z-index:8; pointer-events:none;
  display:none; align-items:center; justify-content:center;
}
.holo-overlay.show { display:flex; }
.holo-ui {
  border:1px solid rgba(0,245,255,0.4); padding:20px;
  background:rgba(0,20,35,0.6); backdrop-filter:blur(4px);
  display:flex; flex-direction:column; gap:10px;
  animation:holoIn 0.5s ease;
}
@keyframes holoIn { from{opacity:0;transform:scale(0.8)} to{opacity:1;transform:scale(1)} }
.holo-btn {
  padding:8px 20px; border:1px solid rgba(0,245,255,0.5); background:rgba(0,245,255,0.05);
  font-family:'Share Tech Mono'; font-size:10px; color:var(--neon-cyan); letter-spacing:2px;
  transition:all 0.2s;
}
.holo-btn.active { background:rgba(0,245,255,0.2); box-shadow:0 0 15px rgba(0,245,255,0.3); }

/* Fitness guide */
.guide-box { background:rgba(57,255,20,0.05); border:1px solid rgba(57,255,20,0.2); padding:10px 14px; font-family:'Share Tech Mono'; font-size:10px; color:var(--neon-green); line-height:1.8; }

/* AR clothes */
.clothes-btns { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
.cl-btn { padding:6px 12px; border:1px solid rgba(255,0,110,0.4); background:transparent; color:var(--neon-pink); font-family:'Share Tech Mono'; font-size:10px; cursor:pointer; transition:all 0.2s; }
.cl-btn:hover,.cl-btn.on { background:rgba(255,0,110,0.1); box-shadow:0 0 10px rgba(255,0,110,0.2); }

/* Scrollbar */
::-webkit-scrollbar { width:3px; height:3px; }
::-webkit-scrollbar-track { background:rgba(0,0,0,0.2); }
::-webkit-scrollbar-thumb { background:rgba(0,245,255,0.25); border-radius:2px; }

/* ============================================================
   ANIMATIONS SUPPL√âMENTAIRES
   ============================================================ */

/* --- Scanning line on camera --- */
.cam-box::after {
  content:'';
  position:absolute; left:0; right:0;
  height:2px;
  background:linear-gradient(90deg, transparent, var(--neon-cyan), transparent);
  box-shadow:0 0 12px var(--neon-cyan);
  animation:scanLine 3s linear infinite;
  z-index:6; pointer-events:none;
  opacity:0.6;
}
@keyframes scanLine {
  0%   { top:-2px; opacity:0; }
  5%   { opacity:0.8; }
  95%  { opacity:0.8; }
  100% { top:100%; opacity:0; }
}

/* --- Corner pulse --- */
.cam-frame::before, .cam-frame::after,
.cam-corner-bl, .cam-corner-tr {
  animation:cornerPulse 2.5s ease-in-out infinite;
}
.cam-corner-bl { animation-delay:0.3s; }
.cam-corner-tr { animation-delay:0.6s; }
@keyframes cornerPulse {
  0%,100% { box-shadow:none; opacity:0.7; }
  50% { box-shadow:0 0 18px var(--neon-cyan); opacity:1; }
}

/* --- Glitch title --- */
.glitch-title {
  position:relative;
  animation:glitch 6s infinite;
}
.glitch-title::before, .glitch-title::after {
  content:attr(data-text);
  position:absolute; top:0; left:0; width:100%;
  background:linear-gradient(135deg,var(--neon-cyan) 0%,var(--neon-pink) 50%,var(--neon-yellow) 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.glitch-title::before {
  animation:glitch-1 6s infinite;
  clip-path: polygon(0 0, 100% 0, 100% 35%, 0 35%);
  transform: translate(-2px, 0);
}
.glitch-title::after {
  animation:glitch-2 6s infinite;
  clip-path: polygon(0 65%, 100% 65%, 100% 100%, 0 100%);
  transform: translate(2px, 0);
}
@keyframes glitch {
  0%,90%,100% { transform:none; }
  92% { transform:skewX(-1deg); }
  94% { transform:skewX(1deg); }
  96% { transform:skewX(-0.5deg); }
}
@keyframes glitch-1 {
  0%,89%,100% { opacity:0; transform:translate(0); }
  90% { opacity:0.6; transform:translate(-3px,1px); }
  92% { opacity:0.6; transform:translate(3px,-1px); }
  94% { opacity:0; }
}
@keyframes glitch-2 {
  0%,91%,100% { opacity:0; transform:translate(0); }
  92% { opacity:0.5; transform:translate(3px,1px); }
  94% { opacity:0.5; transform:translate(-3px,-1px); }
  96% { opacity:0; }
}

/* --- Typewriter breadcrumb --- */
.breadcrumb-animated {
  overflow:hidden;
  white-space:nowrap;
  animation:typewrite 0.4s steps(20,end);
}
@keyframes typewrite {
  from { width:0 }
  to   { width:100% }
}

/* --- Button animations --- */
.btn {
  position:relative;
  overflow:hidden;
  transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
}
.btn::after {
  content:'';
  position:absolute;
  top:50%; left:50%;
  width:0; height:0;
  background:rgba(255,255,255,0.15);
  border-radius:50%;
  transform:translate(-50%,-50%);
  transition:width 0.4s ease, height 0.4s ease, opacity 0.4s ease;
  opacity:0;
}
.btn:active::after {
  width:200px; height:200px; opacity:0;
  transition:0s;
}
.btn-start {
  animation:btnPulse 3s ease-in-out infinite;
}
@keyframes btnPulse {
  0%,100% { box-shadow:0 0 0 0 rgba(0,245,255,0); }
  50% { box-shadow:0 0 0 6px rgba(0,245,255,0.1); }
}
.btn:hover {
  transform:translateY(-2px) scale(1.03) !important;
  letter-spacing:3px !important;
}
.btn:active {
  transform:translateY(0px) scale(0.97) !important;
}

/* --- Sidebar feature item hover --- */
.feat-item {
  transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
  position:relative;
}
.feat-item::after {
  content:'';
  position:absolute; right:10px; top:50%; transform:translateY(-50%);
  width:4px; height:4px; border-radius:50%;
  background:var(--neon-cyan);
  opacity:0; transition:opacity 0.2s;
  box-shadow:0 0 6px var(--neon-cyan);
}
.feat-item:hover::after { opacity:1; }
.feat-item.active::after { opacity:1; background:var(--neon-cyan); animation:dotBlink 1.5s ease-in-out infinite; }
@keyframes dotBlink { 0%,100%{opacity:1} 50%{opacity:0.2} }

/* --- Category header hover --- */
.cat-header {
  transition: background 0.3s, padding-left 0.3s !important;
}
.cat-header:hover { background:rgba(0,245,255,0.03); }
.cat-header.active .cat-title { animation:catTitleGlow 2s ease-in-out infinite; }
@keyframes catTitleGlow {
  0%,100%{text-shadow:none}
  50%{text-shadow:0 0 12px var(--cat-color)}
}

/* --- Metric card animations --- */
.met-card {
  transition: all 0.25s ease !important;
  animation:cardIn 0.4s ease backwards;
}
.met-card:nth-child(1){animation-delay:0.05s}
.met-card:nth-child(2){animation-delay:0.1s}
.met-card:nth-child(3){animation-delay:0.15s}
.met-card:nth-child(4){animation-delay:0.2s}
@keyframes cardIn {
  from { opacity:0; transform:translateX(20px); }
  to   { opacity:1; transform:translateX(0); }
}

/* --- Met value change flash --- */
.met-val { transition:color 0.3s ease; }
.met-val.flash { animation:valFlash 0.3s ease; }
@keyframes valFlash {
  0%,100%{} 50%{color:white !important; text-shadow:0 0 20px currentColor;}
}

/* --- Progress bar fill animation --- */
.met-bar-fill {
  transition: width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
  position:relative;
  overflow:hidden;
}
.met-bar-fill::after {
  content:'';
  position:absolute; top:0; left:-100%; width:100%; height:100%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  animation:shimmer 2s linear infinite;
}
@keyframes shimmer { to { left:100%; } }

/* --- Alert box entrance --- */
.alert-box.show {
  display:block;
  animation:alertIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes alertIn {
  from { opacity:0; transform:translateY(-8px) scale(0.95); }
  to   { opacity:1; transform:translateY(0) scale(1); }
}

/* --- Toast animation --- */
.toast {
  transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
              opacity 0.4s ease !important;
}
.toast:not(.show) { opacity:0; }
.toast.show { opacity:1; }

/* --- Home cards --- */
.cat-card {
  transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
  animation:cardFadeIn 0.5s ease backwards;
}
.cat-card:nth-child(1){animation-delay:0.1s}
.cat-card:nth-child(2){animation-delay:0.2s}
.cat-card:nth-child(3){animation-delay:0.3s}
@keyframes cardFadeIn {
  from { opacity:0; transform:translateY(24px); }
  to   { opacity:1; transform:translateY(0); }
}
.cat-card:hover { transform:translateY(-8px) scale(1.02) !important; }
.cat-card-em { 
  display:inline-block;
  animation:emojiFloat 3s ease-in-out infinite;
}
.cat-card:nth-child(2) .cat-card-em { animation-delay:1s; }
.cat-card:nth-child(3) .cat-card-em { animation-delay:2s; }
@keyframes emojiFloat {
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
}

/* --- Feature panel entrance --- */
.feat-panel.active .cam-panel {
  animation:panelSlideIn 0.35s ease;
}
.feat-panel.active .met-panel {
  animation:panelSlideInR 0.35s ease;
}
@keyframes panelSlideIn {
  from{opacity:0;transform:translateX(-16px)}
  to{opacity:1;transform:translateX(0)}
}
@keyframes panelSlideInR {
  from{opacity:0;transform:translateX(16px)}
  to{opacity:1;transform:translateX(0)}
}

/* --- Rep counter bump improved --- */
.rep-big.bump { animation:repBig 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes repBig {
  0%{transform:scale(1)}
  40%{transform:scale(1.4);color:white;text-shadow:0 0 30px currentColor}
  70%{transform:scale(0.95)}
  100%{transform:scale(1)}
}

/* --- Badge pulse --- */
.badge-live {
  animation:livePulse 2s ease-in-out infinite;
}
@keyframes livePulse {
  0%,100%{opacity:1;box-shadow:none}
  50%{opacity:0.7;box-shadow:0 0 8px var(--neon-green)}
}

/* --- Header logo spin on hover --- */
.logo-icon:hover { animation:spin360 0.5s ease; cursor:default; }
@keyframes spin360 { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

/* --- Status dot ripple --- */
.status-dot::after {
  content:'';
  position:absolute;
  width:7px; height:7px;
  border-radius:50%;
  background:var(--neon-green);
  animation:ripple 2s ease-out infinite;
}
.header-status { position:relative; }
@keyframes ripple {
  0%{transform:scale(1);opacity:0.6}
  100%{transform:scale(3);opacity:0}
}

/* --- Grid background scroll --- */
body::before {
  animation:gridScroll 20s linear infinite !important;
}
@keyframes gridScroll {
  from { background-position:0 0; }
  to   { background-position:40px 40px; }
}

/* --- Loading dots --- */
.loading-dots::after {
  content:'';
  animation:dots 1.5s steps(4,end) infinite;
}
@keyframes dots {
  0%{content:''}
  25%{content:'.'}
  50%{content:'..'}
  75%{content:'...'}
  100%{content:''}
}

/* --- Neon flicker on feat-nm --- */
.feat-nm {
  animation:neonFlicker 8s ease-in-out infinite;
}
@keyframes neonFlicker {
  0%,95%,100%{opacity:1}
  96%{opacity:0.8}
  97%{opacity:1}
  98%{opacity:0.6}
  99%{opacity:1}
}

/* --- Fix camera mirror: video uses CSS mirror, canvas NOT flipped ---*/
.cam-box video {
  transform:scaleX(-1) !important; /* Mirror video display only */
}
.cam-box canvas {
  transform:none !important; /* Canvas draws in correct coordinates */
}

/* --- Animated feat header title bar --- */
.feat-hdr {
  position:relative;
  overflow:hidden;
}
.feat-hdr::after {
  content:'';
  position:absolute;
  bottom:0; left:-100%; width:60%;
  height:1px;
  background:linear-gradient(90deg, transparent, var(--neon-cyan), transparent);
  animation:hdrLine 3s ease-in-out infinite;
}
@keyframes hdrLine {
  0%{left:-60%} 100%{left:110%}
}

/* --- Breadcrumb text slide in --- */
#bcText {
  display:inline-block;
  animation:bcSlide 0.3s ease;
}
@keyframes bcSlide {
  from{opacity:0;transform:translateX(8px)}
  to{opacity:1;transform:translateX(0)}
}

/* --- Sidebar toggle arrow --- */
.cat-title::after {
  content:'‚ñ∏';
  margin-left:auto;
  transition:transform 0.3s ease;
  font-size:10px;
  opacity:0.5;
}
.cat-header.active .cat-title::after {
  transform:rotate(90deg);
  opacity:1;
}

/* --- Met panel title --- */
.met-title {
  animation:metTitleIn 0.5s ease;
  position:relative;
}
.met-title::after {
  content:'';
  position:absolute;
  bottom:-4px; left:0; width:0;
  height:1px;
  background:var(--neon-cyan);
  animation:titleUnderline 0.6s ease 0.2s forwards;
}
@keyframes titleUnderline {
  to { width:100%; }
}
@keyframes metTitleIn {
  from{opacity:0;letter-spacing:8px}
  to{opacity:1;letter-spacing:3px}
}

/* --- Info box slide up --- */
.info-box {
  animation:infoIn 0.4s ease 0.2s backwards;
}
@keyframes infoIn {
  from{opacity:0;transform:translateY(8px)}
  to{opacity:1;transform:translateY(0)}
}

</style>
</head>
<body>

<!-- LOADING -->
<div id="loadingOverlay">
  <div style="font-size:52px;animation:emojiFloat 2s ease-in-out infinite">üß†</div>
  <div class="loading-logo">MEDIAPIPE NEXUS</div>
  <div class="loading-bar-wrap"><div class="loading-bar" id="loadBar"></div></div>
  <div class="loading-text">CHARGEMENT DES MOD√àLES IA<span class="loading-dots"></span></div>
  <div class="loading-status" id="loadStatus">Connexion aux CDN...</div>
  <div style="margin-top:8px;font-family:'Share Tech Mono';font-size:9px;color:rgba(74,127,138,0.6);text-align:center;max-width:340px;line-height:1.8">
    Premi√®re utilisation: t√©l√©chargement ~30MB<br>
    Utilisation suivante: instantan√© (cache navigateur)
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-icon">üß†</div>
    <div>
      <div class="logo-text">MEDIAPIPE NEXUS</div>
      <div class="logo-sub">REAL-TIME VISION AI PLATFORM</div>
    </div>
  </div>
  <div class="header-status">
    <div class="status-dot"></div>
    <span id="mpStatus">CHARGEMENT MEDIAPIPE...</span>
    <span>|</span>
    <span id="fpsDisplay" style="color:var(--neon-cyan)">-- FPS</span>
    <span>|</span>
    <span id="clockEl" style="font-family:'Share Tech Mono'">--:--:--</span>
  </div>
</header>

<div class="app-layout">
<!-- SIDEBAR -->
<nav class="sidebar">

  <!-- CAT 1: VISAGE -->
  <button class="cat-btn" onclick="toggleCat(0)">
    <div class="cat-header" id="cat0" style="--cat-color:#00f5ff">
      <div class="cat-title"><span>üë§</span> ANALYSE VISAGE <span class="cat-count">10</span></div>
      <div class="cat-desc">FACE MESH ¬∑ LANDMARKS ¬∑ AR</div>
    </div>
  </button>
  <div class="feat-list" id="fl0">
    <button class="feat-item" onclick="go('fatigue')">üò¥ D√©tecteur de fatigue <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('blink')">üëÅ Compteur clignements <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('smile')">üì∏ Sourire ‚Üí Photo auto <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('headpose')">ü™ë Posture t√™te/bureau <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('arglasses')">üï∂ Essayage lunettes AR <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('avatar')">üé≠ Avatar expressions <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('filter')">‚ú® Filtres visioconf <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('emotion')">üß† D√©tecteur √©motions <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('faceauth')">üîê Auth visage offline <span class="feat-badge badge-demo">DEMO</span></button>
    <button class="feat-item" onclick="go('speech')">üó£ Coach prononciation <span class="feat-badge badge-live">LIVE</span></button>
  </div>

  <!-- CAT 2: CORPS -->
  <button class="cat-btn" onclick="toggleCat(1)">
    <div class="cat-header" id="cat1" style="--cat-color:#ff006e">
      <div class="cat-title"><span>üèã</span> FITNESS & CORPS <span class="cat-count">10</span></div>
      <div class="cat-desc">POSE DETECTION ¬∑ SPORT</div>
    </div>
  </button>
  <div class="feat-list" id="fl1">
    <button class="feat-item" onclick="go('reps')">ü§∏ Coach fitness (reps) <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('squat')">ü¶µ Correction squat/pompes <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('dance')">üíÉ Jeu danse cam√©ra <span class="feat-badge badge-demo">DEMO</span></button>
    <button class="feat-item" onclick="go('yoga')">üßò Yoga trainer <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('calories')">üî• Calories mouvement <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('fall')">üö® D√©tecteur de chute <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('slides')">üñ• Contr√¥le diapos <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('cardio')">‚ù§ Score cardio <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('challenge')">üèÜ Challenge sport <span class="feat-badge badge-demo">DEMO</span></button>
    <button class="feat-item" onclick="go('stretch')">ü§æ Suivi √©tirements <span class="feat-badge badge-live">LIVE</span></button>
  </div>

  <!-- CAT 3: GESTES & PRO -->
  <button class="cat-btn" onclick="toggleCat(2)">
    <div class="cat-header" id="cat2" style="--cat-color:#39ff14">
      <div class="cat-title"><span>‚úã</span> GESTES & PRO <span class="cat-count">12</span></div>
      <div class="cat-desc">HANDS ¬∑ AR ¬∑ INDUSTRIE</div>
    </div>
  </button>
  <div class="feat-list" id="fl2">
    <button class="feat-item" onclick="go('holo')">üåê Interface hologramme <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('argame')">üëæ Mini jeu AR <span class="feat-badge badge-demo">DEMO</span></button>
    <button class="feat-item" onclick="go('clothes')">üëó Essayage v√™tements <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('dj')">üéß DJ mixer gestes <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('paint')">üé® Peinture lumi√®re <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('keyboard')">‚å® Clavier virtuel air <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('guitar')">üé∏ Air guitar <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('tiktok')">üì± Effets TikTok live <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('security')">ü¶∫ S√©curit√© chantier <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('driver')">üöó Distraction conducteur <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('ergo')">üíº Ergonomie bureau <span class="feat-badge badge-live">LIVE</span></button>
    <button class="feat-item" onclick="go('attendance')">üìã Pr√©sence auto <span class="feat-badge badge-demo">DEMO</span></button>
  </div>

</nav>

<!-- MAIN CONTENT -->
<div class="main-content">
  <div class="breadcrumb">NEXUS / <span id="bcText">ACCUEIL</span></div>
  <div class="content-area" id="contentArea">

    <!-- HOME -->
    <div class="feat-panel active" id="p-home">
      <div class="home-wrap">
        <div>
          <div class="home-title glitch-title" data-text="MEDIAPIPE NEXUS">MEDIAPIPE NEXUS</div>
          <div class="home-sub" style="margin-top:8px">PLATEFORME VISION IA TEMPS R√âEL ¬∑ 32 FONCTIONNALIT√âS</div>
        </div>
        <div class="cat-grid">
          <div class="cat-card cat-card-0" onclick="toggleCat(0);go('fatigue')">
            <span class="cat-card-em">üë§</span>
            <div class="cat-card-nm">ANALYSE VISAGE</div>
            <div class="cat-card-ft">Fatigue ¬∑ Clignements ¬∑ Sourire<br>AR lunettes ¬∑ √âmotions ¬∑ Auth<br>Avatar ¬∑ Filtre ¬∑ Prononciation</div>
          </div>
          <div class="cat-card cat-card-1" onclick="toggleCat(1);go('reps')">
            <span class="cat-card-em">üèã</span>
            <div class="cat-card-nm">FITNESS & CORPS</div>
            <div class="cat-card-ft">Coach reps ¬∑ Squat ¬∑ Danse<br>Yoga ¬∑ Calories ¬∑ Chute<br>Diapos ¬∑ Cardio ¬∑ √âtirements</div>
          </div>
          <div class="cat-card cat-card-2" onclick="toggleCat(2);go('paint')">
            <span class="cat-card-em">‚úã</span>
            <div class="cat-card-nm">GESTES & PRO</div>
            <div class="cat-card-ft">Hologramme ¬∑ DJ ¬∑ Peinture<br>Clavier ¬∑ Guitar ¬∑ TikTok<br>Chantier ¬∑ Ergo ¬∑ Pr√©sence</div>
          </div>
        </div>
        <div id="mpInitMsg" style="font-family:'Share Tech Mono';font-size:10px;color:var(--neon-yellow);text-align:center;padding:12px 16px;border:1px solid rgba(255,224,0,0.2);max-width:600px;line-height:2">
          ‚è≥ T√©l√©chargement des mod√®les IA en cours (~30MB)...<br>
          <span id="mpInitDetail" style="color:var(--text-dim)">Connexion aux serveurs MediaPipe</span><br>
          <span style="color:var(--neon-green);font-size:9px">‚úÖ Aucune installation requise ¬∑ Fonctionne directement dans le navigateur</span>
        </div>
      </div>
    </div>

    <!-- ==================== FEATURE PANELS ==================== -->
    <!-- Will be generated dynamically -->

  </div>
</div>
</div>

<script>
// ================================================================
// CLOCK
// ================================================================
setInterval(() => {
  document.getElementById('clockEl').textContent = new Date().toTimeString().slice(0,8);
}, 1000);

// ================================================================
// TOAST
// ================================================================
let toastTimer;
function toast(msg, type='') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast ' + type;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3200);
}

// ================================================================
// SIDEBAR
// ================================================================
let openCat = -1;
function toggleCat(i) {
  for (let j=0; j<3; j++) {
    document.getElementById(`fl${j}`).classList.remove('open');
    document.getElementById(`cat${j}`).classList.remove('active');
  }
  if (openCat !== i) {
    document.getElementById(`fl${i}`).classList.add('open');
    document.getElementById(`cat${i}`).classList.add('active');
    openCat = i;
  } else {
    openCat = -1;
  }
}

// ================================================================
// PANEL ROUTING
// ================================================================
let currentFeature = 'home';
let activeStream = null;
let animFrame = null;

function go(id) {
  stopAll();
  document.querySelectorAll('.feat-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.feat-item').forEach(b => b.classList.remove('active'));

  currentFeature = id;
  const panel = document.getElementById('p-' + id);
  if (panel) {
    panel.classList.add('active');
  } else {
    buildGenericPanel(id);
    document.getElementById('p-' + id).classList.add('active');
  }
  document.querySelectorAll('.feat-item').forEach(b => {
    if (b.getAttribute('onclick')?.includes(`'${id}'`)) b.classList.add('active');
  });
  const meta = FEATURES[id];
  // Animate breadcrumb
  const bc = document.getElementById('bcText');
  if (bc) {
    bc.style.animation = 'none';
    bc.offsetHeight; // reflow
    bc.textContent = meta?.name || id.toUpperCase();
    bc.style.animation = '';
  }
  toast(`MODULE: ${meta?.name || id}`, 'green');
}

// ================================================================
// FEATURE METADATA
// ================================================================
const FEATURES = {
  fatigue:  {em:'üò¥',name:'D√âTECTEUR DE FATIGUE',       model:'face', tag:'live', desc:'EAR (Eye Aspect Ratio) via Face Mesh. Alerte yeux ferm√©s > 2s. Id√©al conducteurs.'},
  blink:    {em:'üëÅ', name:'COMPTEUR CLIGNEMENTS',       model:'face', tag:'live', desc:'Sant√© des yeux. Alerte < 12 clin/min. R√®gle 20-20-20 pour travailleurs √©cran.'},
  smile:    {em:'üì∏',name:'SOURIRE ‚Üí PHOTO AUTO',        model:'face', tag:'live', desc:'Muscles zygomatiques. D√©clenche photo quand sourire d√©tect√© > 65%.'},
  headpose: {em:'ü™ë',name:'POSTURE T√äTE BUREAU',         model:'face', tag:'live', desc:'Inclinaison/rotation t√™te. Alerte si pench√© > 15¬∞ pendant 30s.'},
  arglasses:{em:'üï∂',name:'ESSAYAGE LUNETTES AR',        model:'face', tag:'live', desc:'Superpose lunettes/chapeaux sur points du visage en temps r√©el.'},
  avatar:   {em:'üé≠',name:'AVATAR EXPRESSIONS',          model:'face', tag:'live', desc:'Clone expressions faciales sur un avatar 2D anim√©.'},
  filter:   {em:'‚ú®',name:'FILTRES VISIOCONF√âRENCE',     model:'face', tag:'live', desc:'Effets visuels fun sur le visage. Id√©al en r√©union.'},
  emotion:  {em:'üß†',name:'D√âTECTEUR √âMOTIONS',          model:'face', tag:'live', desc:'Analyse micro-expressions: heureux, triste, stress, col√®re, neutre.'},
  faceauth: {em:'üîê',name:'AUTH VISAGE OFFLINE',         model:'face', tag:'demo', desc:'Reconnaissance faciale locale. 100% offline, priv√©.'},
  speech:   {em:'üó£',name:'COACH PRONONCIATION',         model:'face', tag:'live', desc:'Analyse mouvements l√®vres/m√¢choire et ouverture bouche.'},
  reps:     {em:'ü§∏',name:'COACH FITNESS (REPS)',        model:'pose', tag:'live', desc:'Compte reps via angles articulaires. Pompes, squats, sit-ups, burpees.'},
  squat:    {em:'ü¶µ',name:'CORRECTION SQUAT',            model:'pose', tag:'live', desc:'Analyse angles genoux/hanche/dos. Score de forme en temps r√©el.'},
  dance:    {em:'üíÉ',name:'JEU DANSE CAM√âRA',            model:'pose', tag:'demo', desc:'Compare ta posture aux chor√©graphies. Score temps r√©el.'},
  yoga:     {em:'üßò',name:'YOGA TRAINER',                model:'pose', tag:'live', desc:'V√©rifie alignement poses de yoga. 30+ poses reconnues.'},
  calories: {em:'üî•',name:'CALORIES PAR MOUVEMENT',     model:'pose', tag:'live', desc:'Estime calories selon amplitude et fr√©quence des mouvements.'},
  fall:     {em:'üö®',name:'D√âTECTEUR DE CHUTE',          model:'pose', tag:'live', desc:'Chute rapide du centre de masse. Alerte automatique.'},
  slides:   {em:'üñ•', name:'CONTR√îLE DIAPOS GESTES',    model:'pose', tag:'live', desc:'Bras lev√© = suivant. Croix bras = pr√©c√©dent. Mains = pause.'},
  cardio:   {em:'‚ù§', name:'SCORE CARDIO',               model:'pose', tag:'live', desc:'Intensit√© cardio selon mouvements. Score 1‚Äì10 en temps r√©el.'},
  challenge:{em:'üèÜ',name:'CHALLENGE SPORT AMIS',        model:'pose', tag:'demo', desc:'Partage records de reps avec amis. Leaderboard hebdo.'},
  stretch:  {em:'ü§æ',name:'SUIVI √âTIREMENTS',            model:'pose', tag:'live', desc:'Guide √©tirements avec timer et v√©rification posture.'},
  holo:     {em:'üåê',name:'INTERFACE HOLOGRAMME',        model:'hand', tag:'live', desc:'UI futuriste contr√¥l√©e par gestes: pinch=cliquer, swipe=d√©filer.'},
  argame:   {em:'üëæ',name:'MINI JEU AR',                 model:'hand', tag:'demo', desc:'Attrape des objets virtuels avec tes mains.'},
  clothes:  {em:'üëó',name:'ESSAYAGE V√äTEMENTS',          model:'pose', tag:'live', desc:'Superpose v√™tements virtuels sur le corps.'},
  dj:       {em:'üéß',name:'DJ MIXER GESTES',             model:'hand', tag:'live', desc:'BPM, volume, effets contr√¥l√©s par positions/mouvements mains.'},
  paint:    {em:'üé®',name:'PEINTURE LUMI√àRE',            model:'hand', tag:'live', desc:'Trace des tra√Æn√©es lumineuses avec l\'index.'},
  keyboard: {em:'‚å®', name:'CLAVIER VIRTUEL AIR',        model:'hand', tag:'live', desc:'Clavier holographique. D√©tecte taps via v√©locit√©.'},
  guitar:   {em:'üé∏',name:'AIR GUITAR',                  model:'hand', tag:'live', desc:'Strumming et accords d√©tect√©s via pose des mains.'},
  tiktok:   {em:'üì±',name:'EFFETS TIKTOK LIVE',          model:'face', tag:'live', desc:'Effets sp√©ciaux activ√©s par gestes ou expressions.'},
  security: {em:'ü¶∫',name:'S√âCURIT√â CHANTIER',           model:'pose', tag:'live', desc:'V√©rifie EPI: casque, gilet, lunettes. Alerte si absent.'},
  driver:   {em:'üöó',name:'DISTRACTION CONDUCTEUR',     model:'face', tag:'live', desc:'D√©tecte regard ailleurs, somnolence, yeux ferm√©s.'},
  ergo:     {em:'üíº',name:'ERGONOMIE BUREAU',            model:'pose', tag:'live', desc:'Dos droit, distance √©cran, position bras. Score ergo.'},
  attendance:{em:'üìã',name:'PR√âSENCE AUTOMATIQUE',       model:'face', tag:'demo', desc:'Reconnaissance faciale pour appel automatique.'},
};

// ================================================================
// BUILD PANELS DYNAMICALLY FOR ALL FEATURES
// ================================================================

function buildFacePanel(id) {
  const m = FEATURES[id];
  const div = document.createElement('div');
  div.className = 'feat-panel';
  div.id = 'p-' + id;
  div.innerHTML = `
    <div class="cam-panel">
      <div class="feat-hdr">
        <span class="feat-em">${m.em}</span>
        <span class="feat-nm">${m.name}</span>
        <span class="tag tag-${m.tag}">${m.tag.toUpperCase()}</span>
      </div>
      <div class="cam-frame">
        <div class="cam-corner-bl"></div><div class="cam-corner-tr"></div>
        <div class="cam-box" id="cb-${id}">
          <div class="cam-placeholder"><div class="ph-icon">${m.em}</div><div>CAM√âRA NON ACTIV√âE</div><div style="font-size:9px;opacity:0.5">Cliquez D√âMARRER</div></div>
          <video id="vid-${id}" autoplay playsinline muted></video>
          <canvas id="cvs-${id}"></canvas>
          ${id==='arglasses'?`<div class="ar-item-overlay" id="ar-item" style="display:none">üï∂</div>`:''}
          ${id==='filter'||id==='tiktok'?`<div id="filter-overlay-${id}" style="position:absolute;inset:0;pointer-events:none;z-index:3;display:none;"></div>`:''}
          ${id==='paint'||id==='keyboard'?`<canvas id="extra-cvs-${id}" style="position:absolute;inset:0;width:100%;height:100%;z-index:4;pointer-events:none;"></canvas>`:''}
        </div>
      </div>
      <div class="cam-controls">
        <button class="btn btn-start" id="btn-start-${id}" onclick="startCam('${id}')">‚ñ∂ D√âMARRER</button>
        <button class="btn btn-stop" onclick="stopAll()">‚ñ† ARR√äTER</button>
        ${getExtraControls(id)}
      </div>
      <div class="info-box">üí° ${m.desc}</div>
    </div>
    <div class="met-panel">
      <div class="met-title">M√âTRIQUES ¬∑ ${m.name.split(' ')[0]}</div>
      ${getMetrics(id)}
    </div>
  `;
  document.getElementById('contentArea').appendChild(div);
}

function buildPosePanel(id) {
  buildFacePanel(id); // same structure, different logic
}

function buildGenericPanel(id) {
  const m = FEATURES[id] || {em:'ü§ñ',name:id,model:'pose',tag:'demo',desc:'Fonctionnalit√© en cours.'};
  buildFacePanel(id);
}

function getExtraControls(id) {
  const map = {
    arglasses: `<button class="btn btn-sim btn-sm" onclick="nextARItem()">üîÑ CHANGER</button>`,
    smile: `<button class="btn btn-sim btn-sm" onclick="simSmile()">üì∏ SIMULER</button>`,
    emotion: `<button class="btn btn-sim btn-sm" onclick="simEmotion()">‚ö° SIMULER</button>`,
    reps: `<button class="btn btn-sim btn-sm" onclick="addRep()">+1 REP</button><button class="btn btn-yellow btn-sm" onclick="resetReps()">‚Ü∫ RESET</button>`,
    paint: `<button class="btn btn-sim btn-sm" onclick="clearPaint()">üóë EFFACER</button>`,
    security: `<button class="btn btn-sim btn-sm" onclick="simSecAlert()">‚ö° ALERTE</button>`,
    driver: `<button class="btn btn-sim btn-sm" onclick="simDriver()">‚ö° SIMULER</button>`,
    holo: `<button class="btn btn-sim btn-sm" onclick="simHolo()">üåê UI</button>`,
    dj: `<button class="btn btn-sim btn-sm" onclick="simDJ()">‚ö° SIMULER</button>`,
    fall: `<button class="btn btn-sim btn-sm" onclick="simFall()">‚ö° SIMULER</button>`,
    squat: `<button class="btn btn-sim btn-sm" onclick="simSquat()">‚ö° SIMULER</button>`,
    fatigue: `<button class="btn btn-sim btn-sm" onclick="simFatigue()">‚ö° SIMULER</button>`,
    slides: `<button class="btn btn-sim btn-sm" onclick="simSlide()">‚ñ∂ NEXT SLIDE</button>`,
  };
  return map[id] || '';
}

function getMetrics(id) {
  const mets = {
    fatigue: `
      <div class="met-card"><div class="met-lbl">EAR (Eye Aspect Ratio)</div><div class="met-val" id="m-ear">0.28</div><div class="met-unit">Seuil alerte: 0.20</div><div class="met-bar"><div class="met-bar-fill" id="b-ear" style="width:70%"></div></div></div>
      <div class="met-card"><div class="met-lbl">Yeux ferm√©s</div><div class="met-val" id="m-eyes-dur">0.0<span style="font-size:13px">s</span></div><div class="met-unit">Critique: &gt; 2.0s</div></div>
      <div class="met-card"><div class="met-lbl">Niveau fatigue</div><div class="met-val" id="m-fat-lvl" style="font-size:15px">NORMAL</div><div class="met-bar"><div class="met-bar-fill" id="b-fat" style="width:15%;background:linear-gradient(90deg,#39ff14,#00f5ff)"></div></div></div>
      <div class="alert-box alert-danger" id="a-fatigue">‚ö† FATIGUE CRITIQUE<br>Yeux ferm√©s > 2s. Prenez une pause!</div>
      <div class="toggle-row">Alerte sonore<div class="tog on" id="tog-snd" onclick="this.classList.toggle('on')"></div></div>`,
    blink: `
      <div class="met-card" style="text-align:center"><div class="met-lbl">CLIGNEMENTS (session)</div><div class="rep-big" id="m-blinks">0</div></div>
      <div class="met-card"><div class="met-lbl">Fr√©quence / min</div><div class="met-val" id="m-blink-rate">0</div><div class="met-unit">Normale: 15‚Äì20 /min</div><div class="met-bar"><div class="met-bar-fill" id="b-blink" style="width:0%"></div></div></div>
      <div class="met-card"><div class="met-lbl">√âtat des yeux</div><div class="met-val" id="m-eye-state" style="font-size:14px;color:var(--neon-green)">BON</div></div>
      <div class="alert-box alert-warn" id="a-blink">‚ö† CLIGNEMENTS FAIBLES<br>Risque yeux secs! Clignez plus.</div>`,
    smile: `
      <div class="met-card"><div class="met-lbl">Intensit√© sourire</div><div class="met-val" id="m-smile">0<span style="font-size:13px">%</span></div><div class="met-bar"><div class="met-bar-fill" id="b-smile" style="width:0%"></div></div></div>
      <div class="met-card"><div class="met-lbl">Photos captur√©es</div><div class="met-val" id="m-photos">0</div><div class="met-unit">Cette session</div></div>
      <div class="met-card"><div class="met-lbl">Dernier d√©clenchement</div><div class="met-val" id="m-last-smile" style="font-size:13px">--</div></div>
      <div class="alert-box alert-ok" id="a-smile">üì∏ PHOTO PRISE!<br>Sourire d√©tect√©.</div>`,
    emotion: `
      <div class="met-card" style="text-align:center"><div class="met-lbl">√âmotion dominante</div><div id="m-emo-icon" style="font-size:44px;margin:8px 0">üòê</div><div id="m-emo-name" style="font-family:'Orbitron';font-size:13px;color:var(--neon-cyan);letter-spacing:2px">NEUTRE</div></div>
      <div class="met-card"><div class="met-lbl">Confiance IA</div><div class="met-val" id="m-emo-conf">--<span style="font-size:13px">%</span></div><div class="met-bar"><div class="met-bar-fill" id="b-emo" style="width:0%"></div></div></div>
      <div class="met-card"><div class="met-lbl">Distribution</div><div class="emo-grid">
        <div class="emo-chip" id="ec-happy">üòä HEUREUX</div>
        <div class="emo-chip" id="ec-sad">üò¢ TRISTE</div>
        <div class="emo-chip" id="ec-stress">üò§ STRESS</div>
        <div class="emo-chip" id="ec-surprised">üò≤ SURPRIS</div>
        <div class="emo-chip" id="ec-neutral">üòê NEUTRE</div>
        <div class="emo-chip" id="ec-angry">üò† COL√àRE</div>
      </div></div>`,
    headpose: `
      <div class="met-card"><div class="met-lbl">Inclinaison t√™te</div><div class="met-val" id="m-pitch">0¬∞</div><div class="met-unit">Avant/arri√®re</div><div class="met-bar"><div class="met-bar-fill" id="b-pitch" style="width:50%"></div></div></div>
      <div class="met-card"><div class="met-lbl">Rotation t√™te</div><div class="met-val" id="m-yaw">0¬∞</div><div class="met-unit">Gauche/droite</div></div>
      <div class="met-card"><div class="met-lbl">Posture</div><div class="met-val" id="m-pose-state" style="font-size:14px;color:var(--neon-green)">CORRECTE ‚úì</div></div>
      <div class="alert-box alert-warn" id="a-headpose">‚ö† POSTURE INCORRECTE<br>Redressez la t√™te! Dos droit.</div>`,
    arglasses: `
      <div class="met-card"><div class="met-lbl">Accessoire actif</div><div id="m-ar-item" style="font-size:42px;text-align:center">üï∂</div></div>
      <div class="met-card"><div class="met-lbl">Points visage track√©s</div><div class="met-val">468</div><div class="met-unit">MediaPipe Face Mesh</div></div>
      <div class="met-card"><div class="met-lbl">Confiance tracking</div><div class="met-val" id="m-ar-conf">--<span style="font-size:13px">%</span></div><div class="met-bar"><div class="met-bar-fill" id="b-ar-conf" style="width:0%"></div></div></div>`,
    reps: `
      <div class="met-card" style="text-align:center"><div class="met-lbl">R√âP√âTITIONS</div><div class="rep-big" id="m-reps">0</div><div id="m-ex-name" style="font-family:'Orbitron';font-size:11px;color:var(--neon-pink);letter-spacing:2px;margin-top:6px">üí™ POMPES</div></div>
      <div class="met-card"><div class="met-lbl">S√©ries</div><div class="met-val" id="m-sets">0</div><div class="met-unit">Objectif: 3 √ó 10</div></div>
      <div class="met-card"><div class="met-lbl">Angle coude/hanche</div><div class="met-val" id="m-angle">--¬∞</div></div>
      <div class="met-card"><div class="met-lbl">Forme</div><div class="met-val" id="m-form" style="font-size:14px;color:var(--neon-green)">--</div></div>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-sm btn-start" onclick="setEx('üí™ POMPES')">üí™</button>
        <button class="btn btn-sm btn-start" onclick="setEx('ü¶µ SQUATS')">ü¶µ</button>
        <button class="btn btn-sm btn-start" onclick="setEx('üèÉ BURPEES')">üèÉ</button>
        <button class="btn btn-sm btn-start" onclick="setEx('ü§∏ SIT-UPS')">ü§∏</button>
      </div>`,
    squat: `
      <div class="met-card"><div class="met-lbl">Angle genoux</div><div class="met-val" id="m-knee">--¬∞</div><div class="met-bar"><div class="met-bar-fill" id="b-knee" style="width:0%"></div></div></div>
      <div class="met-card"><div class="met-lbl">Angle hanche</div><div class="met-val" id="m-hip">--¬∞</div></div>
      <div class="met-card"><div class="met-lbl">Score de forme</div><div class="met-val" id="m-squat-score" style="font-size:36px;text-align:center">--</div><div class="met-unit" style="text-align:center">/ 100</div></div>
      <div class="met-card"><div class="met-lbl">Phase</div><div class="met-val" id="m-squat-phase" style="font-size:14px">DEBOUT</div></div>
      <div class="alert-box alert-warn" id="a-squat">‚ö† FORM INCORRECTE<br>Genoux trop en avant!</div>`,
    holo: `
      <div class="met-card"><div class="met-lbl">Geste d√©tect√©</div><div id="m-gest" style="font-size:42px;text-align:center">‚úã</div></div>
      <div class="met-card"><div class="met-lbl">Points main track√©s</div><div class="met-val">21</div><div class="met-unit">MediaPipe Hands</div></div>
      <div class="met-card"><div class="met-lbl">Confiance</div><div class="met-val" id="m-hand-conf">--<span style="font-size:13px">%</span></div><div class="met-bar"><div class="met-bar-fill" id="b-hand-conf" style="width:0%"></div></div></div>
      <div class="met-card"><div class="met-lbl">Actions d√©clench√©es</div><div class="met-val" id="m-holo-acts">0</div></div>`,
    paint: `
      <div class="met-card"><div class="met-lbl">Couleur active</div><div id="m-paint-color" style="width:100%;height:30px;background:linear-gradient(90deg,var(--neon-cyan),var(--neon-pink));margin-top:6px;box-shadow:0 0 15px rgba(0,245,255,0.4)"></div></div>
      <div class="met-card"><div class="met-lbl">√âpaisseur trait</div><div class="met-val" id="m-brush-size">6px</div></div>
      <div class="met-card"><div class="met-lbl">Points trac√©s</div><div class="met-val" id="m-paint-pts">0</div></div>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-sm" style="border-color:#00f5ff;color:#00f5ff" onclick="setPaintColor('#00f5ff')">CYAN</button>
        <button class="btn btn-sm" style="border-color:#ff006e;color:#ff006e" onclick="setPaintColor('#ff006e')">ROSE</button>
        <button class="btn btn-sm" style="border-color:#39ff14;color:#39ff14" onclick="setPaintColor('#39ff14')">VERT</button>
        <button class="btn btn-sm" style="border-color:#ffe000;color:#ffe000" onclick="setPaintColor('#ffe000')">JAUNE</button>
      </div>`,
    dj: `
      <div class="met-card"><div class="met-lbl">BPM</div><div class="met-val" id="m-bpm">120</div></div>
      <div class="met-card"><div class="dj-mix">
        <div class="dj-slider-row"><span>VOLUME</span><div class="dj-bar"><div class="dj-bar-fill" id="dj-vol" style="width:60%"></div></div><span id="dj-vol-v" style="width:30px;text-align:right">60%</span></div>
        <div class="dj-slider-row"><span>BASSE</span><div class="dj-bar"><div class="dj-bar-fill" id="dj-bass" style="width:50%"></div></div><span id="dj-bass-v" style="width:30px;text-align:right">50%</span></div>
        <div class="dj-slider-row"><span>TREBLE</span><div class="dj-bar"><div class="dj-bar-fill" id="dj-treble" style="width:40%"></div></div><span id="dj-treble-v" style="width:30px;text-align:right">40%</span></div>
      </div></div>
      <div class="met-card"><div class="met-lbl">Geste DJ</div><div class="met-val" id="m-dj-gest" style="font-size:14px;color:var(--neon-pink)">EN ATTENTE</div></div>`,
    security: `
      <div class="met-card"><div class="met-lbl">Statut EPI</div><div class="met-val" id="m-epi" style="color:var(--neon-green);font-size:16px">CONFORME ‚úì</div></div>
      <div class="met-card"><div class="met-lbl">Casque</div><div class="met-val" id="m-helmet" style="color:var(--neon-green);font-size:16px">PORT√â ‚úì</div></div>
      <div class="met-card"><div class="met-lbl">Gilet HV</div><div class="met-val" id="m-vest" style="color:var(--neon-green);font-size:16px">PORT√â ‚úì</div></div>
      <div class="met-card"><div class="met-lbl">Alertes session</div><div class="met-val" id="m-sec-alerts">0</div></div>
      <div class="alert-box alert-danger" id="a-security">üö® ALERTE S√âCURIT√â<br>EPI manquant d√©tect√©!</div>`,
    driver: `
      <div class="met-card"><div class="met-lbl">Regard</div><div class="met-val" id="m-gaze" style="font-size:15px;color:var(--neon-green)">ROUTE ‚úì</div></div>
      <div class="met-card"><div class="met-lbl">Somnolence</div><div class="met-val" id="m-drows">0<span style="font-size:13px">%</span></div><div class="met-bar"><div class="met-bar-fill" id="b-drows" style="width:0%"></div></div></div>
      <div class="met-card"><div class="met-lbl">B√¢illements</div><div class="met-val" id="m-yawn">0</div><div class="met-unit">Cette session</div></div>
      <div class="alert-box alert-danger" id="a-driver">üöó DISTRACTION D√âTECT√âE<br>Ram√®nez votre attention sur la route!</div>`,
    fall: `
      <div class="met-card"><div class="met-lbl">Centre de masse Y</div><div class="met-val" id="m-cmy">--</div><div class="met-bar"><div class="met-bar-fill" id="b-cmy" style="width:50%"></div></div></div>
      <div class="met-card"><div class="met-lbl">V√©locit√© chute</div><div class="met-val" id="m-fall-vel">0<span style="font-size:13px">px/s</span></div></div>
      <div class="met-card"><div class="met-lbl">Statut</div><div class="met-val" id="m-fall-stat" style="font-size:14px;color:var(--neon-green)">STABLE ‚úì</div></div>
      <div class="alert-box alert-danger" id="a-fall">üö® CHUTE D√âTECT√âE!<br>Alerte envoy√©e!</div>`,
    keyboard: `
      <div class="met-card"><div class="met-lbl">Derni√®re touche</div><div class="met-val" id="m-key-last" style="font-size:36px;text-align:center">--</div></div>
      <div class="met-card"><div class="met-lbl">Texte saisi</div><div id="m-key-text" style="font-family:'Share Tech Mono';font-size:12px;color:var(--neon-cyan);word-break:break-all;min-height:30px;padding:6px;background:rgba(0,245,255,0.05);border:1px solid rgba(0,245,255,0.15);margin-top:4px;"></div></div>
      <div class="met-card"><div class="met-lbl">Touches / min</div><div class="met-val" id="m-kpm">0</div></div>`,
    ergo: `
      <div class="met-card"><div class="met-lbl">Score ergonomie</div><div class="met-val" id="m-ergo-score" style="font-size:36px;text-align:center">--</div><div class="met-unit" style="text-align:center">/ 100</div></div>
      <div class="met-card"><div class="met-lbl">√âpaules</div><div class="met-val" id="m-shoulders" style="font-size:14px;color:var(--neon-green)">OK</div></div>
      <div class="met-card"><div class="met-lbl">Dos</div><div class="met-val" id="m-back" style="font-size:14px;color:var(--neon-green)">DROIT ‚úì</div></div>
      <div class="alert-box alert-warn" id="a-ergo">‚ö† POSTURE BUREAU<br>Redressez le dos!</div>`,
    slides: `
      <div class="met-card"><div class="met-lbl">Diapositive</div><div class="met-val" id="m-slide-n" style="font-size:36px;text-align:center">1</div><div class="met-unit" style="text-align:center">/ 12</div></div>
      <div class="met-card"><div class="met-lbl">Geste</div><div class="met-val" id="m-slide-gest" style="font-size:14px;color:var(--neon-cyan)">EN ATTENTE</div></div>
      <div class="met-card"><div class="met-lbl">Commandes</div><div style="font-family:'Share Tech Mono';font-size:9px;color:var(--text-dim);line-height:2">üñê Bras D lev√© = SUIVANT<br>ü§ö Bras G lev√© = PR√âC√âDENT<br>‚úã Les deux = PAUSE<br>üëÜ Pointer = LASER</div></div>`,
    calories: `
      <div class="met-card"><div class="met-lbl">Calories br√ªl√©es</div><div class="met-val" id="m-cals" style="font-size:36px;text-align:center;color:var(--neon-pink)">0</div><div class="met-unit" style="text-align:center">kcal (estim√©)</div></div>
      <div class="met-card"><div class="met-lbl">Intensit√©</div><div class="met-val" id="m-intensity">FAIBLE</div><div class="met-bar"><div class="met-bar-fill" id="b-intensity" style="width:10%"></div></div></div>
      <div class="met-card"><div class="met-lbl">Temps actif</div><div class="met-val" id="m-active-time">0:00</div></div>`,
    cardio: `
      <div class="met-card" style="text-align:center"><div class="met-lbl">SCORE CARDIO</div><div class="rep-big" id="m-cardio" style="color:var(--neon-pink)">0</div><div style="font-family:'Share Tech Mono';font-size:10px;color:var(--text-dim);margin-top:4px">/ 10</div></div>
      <div class="met-card"><div class="met-lbl">Mouvement d√©tect√©</div><div class="met-val" id="m-move" style="font-size:14px">AUCUN</div></div>
      <div class="met-card"><div class="met-lbl">Dur√©e session</div><div class="met-val" id="m-cardio-time">0:00</div></div>`,
    yoga: `
      <div class="met-card"><div class="met-lbl">Pose d√©tect√©e</div><div class="met-val" id="m-yoga-pose" style="font-size:14px;color:var(--neon-cyan)">DEBOUT</div></div>
      <div class="met-card"><div class="met-lbl">Score alignement</div><div class="met-val" id="m-yoga-score" style="font-size:36px;text-align:center">--</div><div class="met-unit" style="text-align:center">/ 100</div></div>
      <div class="met-card"><div class="met-lbl">√âquilibre</div><div class="met-val" id="m-balance" style="font-size:14px;color:var(--neon-green)">STABLE</div></div>`,
    stretch: `
      <div class="met-card"><div class="met-lbl">√âtirement actif</div><div class="met-val" id="m-stretch-name" style="font-size:14px">--</div></div>
      <div class="met-card"><div class="met-lbl">Dur√©e tenu</div><div class="met-val" id="m-stretch-time">0<span style="font-size:13px">s</span></div><div class="met-unit">Recommand√©: 30s</div><div class="met-bar"><div class="met-bar-fill" id="b-stretch" style="width:0%;background:linear-gradient(90deg,var(--neon-green),var(--neon-cyan))"></div></div></div>
      <div class="met-card"><div class="met-lbl">√âtirements compl√©t√©s</div><div class="met-val" id="m-stretch-done">0</div></div>`,
    guitar: `
      <div class="met-card"><div class="met-lbl">Accord d√©tect√©</div><div class="met-val" id="m-chord" style="font-size:28px;text-align:center">--</div></div>
      <div class="met-card"><div class="met-lbl">Strumming</div><div class="met-val" id="m-strum" style="font-size:14px">AUCUN</div><div class="met-bar"><div class="met-bar-fill" id="b-strum" style="width:0%"></div></div></div>
      <div class="met-card"><div class="met-lbl">Notes jou√©es</div><div class="met-val" id="m-notes">0</div></div>`,
    tiktok: `
      <div class="met-card"><div class="met-lbl">Effet actif</div><div class="met-val" id="m-effect" style="font-size:14px;color:var(--neon-pink)">AUCUN</div></div>
      <div class="met-card"><div class="met-lbl">Trigger d√©tect√©</div><div class="met-val" id="m-trigger" style="font-size:14px">--</div></div>
      <div class="met-card"><div class="met-lbl">Effets appliqu√©s</div><div class="met-val" id="m-effects-count">0</div></div>`,
    clothes: `
      <div class="met-card"><div class="met-lbl">V√™tement actif</div><div id="m-cloth-item" style="font-size:42px;text-align:center">üëï</div></div>
      <div class="met-card"><div class="met-lbl">Points corps</div><div class="met-val">33</div><div class="met-unit">MediaPipe Pose</div></div>`,
    avatar: `
      <div class="met-card"><div class="met-lbl">Expression clone</div><div id="m-avatar-state" style="font-size:42px;text-align:center">üòê</div></div>
      <div class="met-card"><div class="met-lbl">Points mimiques</div><div class="met-val">68</div><div class="met-unit">Face Landmarks</div></div>`,
    filter: `
      <div class="met-card"><div class="met-lbl">Filtre actif</div><div class="met-val" id="m-filter-name" style="font-size:14px;color:var(--neon-cyan)">AUCUN</div></div>
      <div class="met-card"><div class="met-lbl">FPS rendu</div><div class="met-val" id="m-filter-fps">--</div></div>`,
    faceauth: `
      <div class="met-card"><div class="met-lbl">Statut</div><div class="met-val" id="m-auth-stat" style="font-size:14px;color:var(--neon-yellow)">EN ATTENTE</div></div>
      <div class="met-card"><div class="met-lbl">Similarit√©</div><div class="met-val" id="m-auth-sim">0<span style="font-size:13px">%</span></div><div class="met-bar"><div class="met-bar-fill" id="b-auth" style="width:0%"></div></div></div>
      <div class="alert-box alert-ok" id="a-auth-ok">‚úì ACC√àS AUTORIS√â</div>
      <div class="alert-box alert-danger" id="a-auth-no">‚úó ACC√àS REFUS√â</div>
      <button class="btn btn-sim" style="width:100%;margin-top:8px" onclick="simAuth()">SIMULER AUTH</button>`,
    speech: `
      <div class="met-card"><div class="met-lbl">Ouverture bouche</div><div class="met-val" id="m-mouth">0<span style="font-size:13px">%</span></div><div class="met-bar"><div class="met-bar-fill" id="b-mouth" style="width:0%"></div></div></div>
      <div class="met-card"><div class="met-lbl">Phon√®me d√©tect√©</div><div class="met-val" id="m-phoneme" style="font-size:28px;text-align:center">--</div></div>
      <div class="met-card"><div class="met-lbl">Score prononciation</div><div class="met-val" id="m-speech-score">--<span style="font-size:13px">%</span></div></div>`,
    attendance: `
      <div class="met-card"><div class="met-lbl">Visages d√©tect√©s</div><div class="met-val" id="m-faces-count">0</div></div>
      <div class="met-card"><div class="met-lbl">Identifi√©s</div><div class="met-val" id="m-att-id" style="color:var(--neon-green)">0</div></div>
      <div class="met-card"><div class="met-lbl">Statut</div><div class="met-val" id="m-att-stat" style="font-size:14px">EN ATTENTE</div></div>
      <button class="btn btn-sim" style="width:100%;margin-top:8px" onclick="simAttendance()">üìã SIMULER APPEL</button>`,
    dance: `
      <div class="met-card" style="text-align:center"><div class="met-lbl">SCORE</div><div class="rep-big" id="m-dance-score" style="color:var(--neon-yellow)">0</div></div>
      <div class="met-card"><div class="met-lbl">Synchronisation</div><div class="met-val" id="m-sync">0<span style="font-size:13px">%</span></div><div class="met-bar"><div class="met-bar-fill" id="b-sync" style="width:0%"></div></div></div>
      <div class="met-card"><div class="met-lbl">Combo</div><div class="met-val" id="m-combo">x0</div></div>`,
    challenge: `
      <div class="met-card"><div class="met-lbl">Ton score</div><div class="met-val" id="m-ch-score" style="font-size:28px">0 reps</div></div>
      <div class="met-card"><div class="met-lbl">Leaderboard</div><div style="font-family:'Share Tech Mono';font-size:10px;color:var(--text-dim);line-height:2.2;margin-top:6px">
        ü•á <span style="color:var(--neon-yellow)">Alex</span> ‚Äî 47 reps<br>
        ü•à <span style="color:var(--text-primary)">Maria</span> ‚Äî 42 reps<br>
        ü•â <span style="color:var(--neon-pink)">Tom</span> ‚Äî 38 reps<br>
        <span style="color:var(--neon-cyan)">Toi</span> ‚Äî 0 reps
      </div></div>`,
    argame: `
      <div class="met-card" style="text-align:center"><div class="met-lbl">SCORE</div><div class="rep-big" id="m-game-score" style="color:var(--neon-yellow)">0</div></div>
      <div class="met-card"><div class="met-lbl">Objets attrap√©s</div><div class="met-val" id="m-caught">0</div></div>
      <div class="met-card"><div class="met-lbl">Vies</div><div class="met-val" id="m-lives" style="color:var(--neon-pink)">‚ù§‚ù§‚ù§</div></div>
      <button class="btn btn-sim" style="width:100%;margin-top:8px" onclick="simARGame()">‚ñ∂ D√âMARRER JEU</button>`,
  };
  return mets[id] || `
    <div class="met-card"><div class="met-lbl">STATUT</div><div class="met-val" id="m-gen-stat" style="font-size:14px;color:var(--neon-cyan)">PR√äT</div></div>
    <div class="met-card"><div class="met-lbl">FPS</div><div class="met-val" id="m-fps-gen">--</div></div>
    <div class="met-card"><div class="met-lbl">Confiance IA</div><div class="met-val" id="m-conf-gen">--<span style="font-size:13px">%</span></div></div>`;
}

// Build all panels on start
for (const id of Object.keys(FEATURES)) {
  if (!document.getElementById('p-' + id)) buildGenericPanel(id);
}

// ================================================================
// MEDIAPIPE INITIALIZATION
// ================================================================
let faceLandmarker = null;
let poseLandmarker = null;
let handLandmarker = null;
let mpReady = { face: false, pose: false, hand: false };

// The ESM <script type="module"> sets window._mpClasses
function resolveMP() {
  // Priority 1: set by our async loader
  if (window._mpClasses?.FaceLandmarker && window._mpClasses?.FilesetResolver) {
    return window._mpClasses;
  }
  // Priority 2: bundle exposed globals directly on window
  if (window.FaceLandmarker && window.FilesetResolver) {
    return window;
  }
  // Priority 3: sub-namespaces some bundles use
  for (const ns of [window.vision, window.mediapipe, window.tasks, window.mp]) {
    if (ns?.FaceLandmarker && ns?.FilesetResolver) return ns;
  }
  return null;
}

// Models hosted on Google Storage (stable, no auth needed)
const MODEL_BASE = 'https://storage.googleapis.com/mediapipe-models';

// WASM runtime ‚Äî jsDelivr is most reliable for file:// CORS
const WASM_PATHS = [
  'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm',
  'https://unpkg.com/@mediapipe/tasks-vision@0.10.14/wasm',
];

// Model URLs with fallbacks
const MODEL_URLS = {
  face: `${MODEL_BASE}/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
  pose: `${MODEL_BASE}/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task`,
  hand: `${MODEL_BASE}/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
};

async function initMediaPipe() {
  setLoadStatus('Attente chargement module...', 5);

  // Attendre que le <script type="module"> ait fini (max 15s)
  for (let i = 0; i < 150 && !window._mpLoadDone; i++) {
    await new Promise(r => setTimeout(r, 100));
  }

  let mp = resolveMP();

  // Si le module ESM n'a pas charg√©, on ne peut rien faire sans connexion
  if (!mp) {
    throw new Error('MediaPipe introuvable. Connexion internet requise (1√®re utilisation).');
  }

  const { FaceLandmarker, PoseLandmarker, HandLandmarker, FilesetResolver } = mp;

  // Charger le runtime WASM
  setLoadStatus('Initialisation runtime WebAssembly...', 15);
  let vision = null;
  for (const wasmPath of WASM_PATHS) {
    try {
      vision = await FilesetResolver.forVisionTasks(wasmPath);
      console.log('‚úÖ WASM depuis:', wasmPath);
      break;
    } catch(e) { console.warn('WASM √©chou√©:', wasmPath, '-', e.message); }
  }
  if (!vision) throw new Error('Runtime WASM inaccessible.');

  // Mod√®le Visage
  setLoadStatus('‚¨á Mod√®le Visage (~8MB)...', 28);
  try {
    faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
      baseOptions: { modelAssetPath: MODEL_URLS.face, delegate: 'GPU' },
      outputFaceBlendshapes: true, runningMode: 'VIDEO', numFaces: 1
    });
    mpReady.face = true;
    setLoadStatus('‚úì Visage  ‚¨á Mod√®le Corps (~6MB)...', 52);
  } catch(e) { console.warn('Face:', e.message); setLoadStatus('Visage: √©chec ¬∑ Corps...', 52); }

  // Mod√®le Pose
  try {
    poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
      baseOptions: { modelAssetPath: MODEL_URLS.pose, delegate: 'GPU' },
      runningMode: 'VIDEO', numPoses: 1
    });
    mpReady.pose = true;
    setLoadStatus('‚úì Visage ¬∑ ‚úì Corps  ‚¨á Mod√®le Mains...', 75);
  } catch(e) { console.warn('Pose:', e.message); setLoadStatus('Corps: √©chec ¬∑ Mains...', 75); }

  // Mod√®le Mains
  try {
    handLandmarker = await HandLandmarker.createFromOptions(vision, {
      baseOptions: { modelAssetPath: MODEL_URLS.hand, delegate: 'GPU' },
      runningMode: 'VIDEO', numHands: 2
    });
    mpReady.hand = true;
    setLoadStatus('‚úì Tous mod√®les pr√™ts!', 100);
  } catch(e) { console.warn('Hand:', e.message); setLoadStatus('Mains: √©chec', 100); }

  const loaded = [mpReady.face && 'Visage', mpReady.pose && 'Corps', mpReady.hand && 'Mains'].filter(Boolean);
  const statusEl = document.getElementById('mpStatus');
  statusEl.textContent = loaded.length > 0 ? `IA ACTIVE ‚úì ‚Äî ${loaded.join(' ¬∑ ')}` : 'MODE SIMULATION';
  statusEl.className = loaded.length > 0 ? 'ready' : '';
  document.getElementById('mpInitMsg').style.display = 'none';
  setTimeout(() => document.getElementById('loadingOverlay').classList.add('hidden'), 500);
}

function setLoadStatus(msg, pct) {
  document.getElementById('loadStatus').textContent = msg;
  document.getElementById('loadBar').style.width = pct + '%';
  document.getElementById('mpInitDetail').textContent = msg;
}

// ================================================================
// CAMERA & PROCESSING LOOP
// ================================================================
let lastVideoTime = -1;
let fpsCounter = 0;
let lastFpsTime = Date.now();

async function startCam(id) {
  stopAll();
  const btn = document.getElementById('btn-start-' + id);
  if (btn) btn.disabled = true;
  
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { width: 640, height: 480, facingMode: 'user' } 
    });
    activeStream = stream;

    const vid = document.getElementById('vid-' + id);
    const cvs = document.getElementById('cvs-' + id);
    if (!vid || !cvs) { toast('Erreur: √©l√©ments non trouv√©s', 'pink'); return; }

    vid.srcObject = stream;
    await vid.play();

    cvs.width = 640;
    cvs.height = 480;
    vid.classList.add('active');
    cvs.classList.add('active');

    const placeholder = document.querySelector(`#cb-${id} .cam-placeholder`);
    if (placeholder) placeholder.style.display = 'none';

    // Init extra canvas if needed
    const extra = document.getElementById('extra-cvs-' + id);
    if (extra) { extra.width = 640; extra.height = 480; }

    toast('CAM√âRA ACTIV√âE ‚ñ∂', 'green');
    if (btn) btn.disabled = false;

    processLoop(id, vid, cvs);

  } catch(e) {
    toast('ERREUR CAM√âRA: ' + e.message, 'pink');
    if (btn) btn.disabled = false;
    // Run in simulation mode
    runSimMode(id);
  }
}

function stopAll() {
  if (activeStream) {
    activeStream.getTracks().forEach(t => t.stop());
    activeStream = null;
  }
  if (animFrame) { cancelAnimationFrame(animFrame); animFrame = null; }
  
  document.querySelectorAll('.feat-panel video.active').forEach(v => {
    v.srcObject = null;
    v.classList.remove('active');
  });
  document.querySelectorAll('.feat-panel canvas.active').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.cam-placeholder').forEach(p => p.style.removeProperty('display'));
  
  clearInterval(simModeInterval);
  toast('ARR√äT√â ‚ñ†');
}

// ================================================================
// MAIN PROCESSING LOOP
// ================================================================
function processLoop(id, vid, cvs) {
  const ctx = cvs.getContext('2d');
  const feat = FEATURES[id];

  function loop() {
    if (!activeStream) return;
    animFrame = requestAnimationFrame(loop);

    if (vid.currentTime === lastVideoTime) return;
    lastVideoTime = vid.currentTime;
    const ts = performance.now();

    // FPS
    fpsCounter++;
    if (Date.now() - lastFpsTime > 1000) {
      document.getElementById('fpsDisplay').textContent = fpsCounter + ' FPS';
      fpsCounter = 0;
      lastFpsTime = Date.now();
    }

    // Draw video normally ‚Äî CSS handles the mirror on <video> element
    // Canvas is NOT mirrored so we draw at natural coordinates
    ctx.drawImage(vid, 0, 0, cvs.width, cvs.height);

    const model = feat?.model || 'face';
    let results = null;

    try {
      if (model === 'face' && faceLandmarker) {
        results = faceLandmarker.detectForVideo(vid, ts);
        processFaceResults(id, ctx, cvs, results);
      } else if (model === 'pose' && poseLandmarker) {
        results = poseLandmarker.detectForVideo(vid, ts);
        processPoseResults(id, ctx, cvs, results);
      } else if (model === 'hand' && handLandmarker) {
        results = handLandmarker.detectForVideo(vid, ts);
        processHandResults(id, ctx, cvs, results);
      } else {
        // Fallback: simulated
        drawFallbackOverlay(ctx, cvs, id);
      }
    } catch(e) {
      drawFallbackOverlay(ctx, cvs, id);
    }
  }
  loop();
}

// ================================================================
// FACE PROCESSING
// ================================================================
const EYE_LEFT  = [362,385,387,263,373,380];
const EYE_RIGHT = [33,160,158,133,153,144];
let eyesClosedStart = null;
let blinkCooldown = 0;
let blinkCountTotal = 0;
let blinkMinuteData = [];
let smilePhotosCount = 0;
let smileCooldown = 0;
const arItems = ['üï∂','üëì','üé©','ü§ø','‚õë','üéì','üï∂','üåÇ'];
let arItemIdx = 0;
const faceEmotions = [
  {e:'üòä',n:'HEUREUX',id:'ec-happy'},
  {e:'üò¢',n:'TRISTE',id:'ec-sad'},
  {e:'üò§',n:'STRESS√â',id:'ec-stress'},
  {e:'üò≤',n:'SURPRIS',id:'ec-surprised'},
  {e:'üòê',n:'NEUTRE',id:'ec-neutral'},
  {e:'üò†',n:'COL√àRE',id:'ec-angry'},
];

function calcEAR(pts, indices) {
  if (!pts || pts.length < 468) return 0.3;
  const p = (i) => pts[i];
  const dist = (a,b) => Math.hypot(a.x-b.x, a.y-b.y);
  const h1 = dist(p(indices[1]), p(indices[5]));
  const h2 = dist(p(indices[2]), p(indices[4]));
  const w  = dist(p(indices[0]), p(indices[3]));
  return w > 0 ? (h1 + h2) / (2 * w) : 0.3;
}

function calcMouthOpen(pts) {
  if (!pts || pts.length < 468) return 0;
  const top = pts[13], bot = pts[14], left = pts[78], right = pts[308];
  const vert = Math.hypot(top.x-bot.x, top.y-bot.y);
  const horiz = Math.hypot(left.x-right.x, left.y-right.y);
  return horiz > 0 ? Math.min(1, vert / horiz) : 0;
}

function calcSmile(blendshapes) {
  if (!blendshapes || !blendshapes.length) return 0;
  const bs = blendshapes[0]?.categories || [];
  const ml = bs.find(c=>c.categoryName==='mouthSmileLeft')?.score || 0;
  const mr = bs.find(c=>c.categoryName==='mouthSmileRight')?.score || 0;
  return (ml + mr) / 2;
}

function getHeadPose(pts) {
  if (!pts || pts.length < 468) return {pitch:0,yaw:0};
  const nose = pts[1], chin = pts[152], lEye = pts[33], rEye = pts[263];
  const pitch = (chin.y - nose.y) * 90 - 20;
  const yaw   = (lEye.x - rEye.x) * 180 - 5;
  return { pitch: Math.round(pitch), yaw: Math.round(yaw) };
}

function processFaceResults(id, ctx, cvs, results) {
  if (!results?.faceLandmarks?.length) {
    drawNobodyText(ctx, cvs);
    return;
  }

  const lm = results.faceLandmarks[0];
  const bs = results.faceBlendshapes;
  const W = cvs.width, H = cvs.height;

  // Draw mesh (light)
  if (['avatar','filter','tiktok','faceauth','attendance'].includes(id)) {
    drawFaceMesh(ctx, lm, W, H);
  }

  // Draw face outline
  drawFaceOutline(ctx, lm, W, H);

  if (id === 'fatigue') {
    const earL = calcEAR(lm, EYE_LEFT);
    const earR = calcEAR(lm, EYE_RIGHT);
    const ear  = (earL + earR) / 2;
    const earPct = Math.min(100, ear * 250);

    setEl('m-ear', ear.toFixed(3));
    setBar('b-ear', earPct);

    const closed = ear < 0.20;
    if (closed && !eyesClosedStart) eyesClosedStart = Date.now();
    else if (!closed) eyesClosedStart = null;

    const closedDur = eyesClosedStart ? (Date.now()-eyesClosedStart)/1000 : 0;
    setEl('m-eyes-dur', closedDur.toFixed(1)+'s');

    const fatPct = Math.min(100, closedDur * 40);
    const fatLvl = closedDur > 2 ? 'CRITIQUE' : closedDur > 1 ? '√âLEV√â' : 'NORMAL';
    setEl('m-fat-lvl', fatLvl);
    setBar('b-fat', fatPct);
    setStyle('m-fat-lvl','color', closedDur>2?'var(--neon-pink)':closedDur>1?'var(--neon-yellow)':'var(--neon-green)');
    showAlert('a-fatigue', closedDur > 2);

    // Eye highlight
    const eyeColor = closed ? '#ff006e' : '#00f5ff';
    drawEyeBox(ctx, lm, W, H, eyeColor);
  }

  if (id === 'blink') {
    const earL = calcEAR(lm, EYE_LEFT);
    const earR = calcEAR(lm, EYE_RIGHT);
    const ear  = (earL + earR) / 2;
    const closed = ear < 0.18;

    if (closed && blinkCooldown <= 0) {
      blinkCountTotal++;
      blinkMinuteData.push(Date.now());
      setEl('m-blinks', blinkCountTotal);
      document.getElementById('m-blinks')?.classList.add('bump');
      setTimeout(() => document.getElementById('m-blinks')?.classList.remove('bump'), 250);
      blinkCooldown = 20;
    }
    if (blinkCooldown > 0) blinkCooldown--;

    blinkMinuteData = blinkMinuteData.filter(t => Date.now()-t < 60000);
    const rate = blinkMinuteData.length;
    setEl('m-blink-rate', rate);
    setBar('b-blink', Math.min(100, rate/25*100));
    const eyeState = rate < 12 ? 'SEC ‚ö†' : 'BON ‚úì';
    setEl('m-eye-state', eyeState);
    setStyle('m-eye-state','color', rate<12?'var(--neon-yellow)':'var(--neon-green)');
    showAlert('a-blink', rate < 12 && rate > 0);

    drawEyeBox(ctx, lm, W, H, '#00f5ff');
  }

  if (id === 'smile') {
    const smile = calcSmile(bs);
    const smilePct = Math.round(smile * 100);
    setEl('m-smile', smilePct + '%');
    setBar('b-smile', smilePct);

    if (smilePct > 65 && smileCooldown <= 0) {
      smilePhotosCount++;
      setEl('m-photos', smilePhotosCount);
      setEl('m-last-smile', new Date().toLocaleTimeString());
      showAlert('a-smile', true);
      setTimeout(() => showAlert('a-smile', false), 2000);
      // Flash effect
      const cb = document.getElementById('cb-smile');
      if (cb) { const fl = document.createElement('div'); fl.style.cssText='position:absolute;inset:0;background:white;z-index:20;animation:none;opacity:0.8;'; cb.appendChild(fl); setTimeout(()=>fl.remove(),300); }
      smileCooldown = 90;
      toast('üì∏ PHOTO PRISE! Sourire ' + smilePct + '%', 'green');
    }
    if (smileCooldown > 0) smileCooldown--;

    // Draw smile indicator
    const color = smilePct > 50 ? '#39ff14' : '#00f5ff';
    drawSmileBox(ctx, lm, W, H, smilePct, color);
  }

  if (id === 'headpose') {
    const hp = getHeadPose(lm);
    setEl('m-pitch', hp.pitch + '¬∞');
    setEl('m-yaw', hp.yaw + '¬∞');
    setBar('b-pitch', 50 + hp.pitch);

    const bad = Math.abs(hp.pitch) > 15 || Math.abs(hp.yaw) > 20;
    setEl('m-pose-state', bad ? 'INCORRECTE ‚úó' : 'CORRECTE ‚úì');
    setStyle('m-pose-state','color', bad?'var(--neon-pink)':'var(--neon-green)');
    showAlert('a-headpose', bad);

    // Draw axis lines
    drawHeadAxis(ctx, lm, W, H, hp);
  }

  if (id === 'arglasses') {
    const conf = Math.round(90 + Math.random()*8);
    setEl('m-ar-conf', conf + '%');
    setBar('b-ar-conf', conf);
    placeARItem(lm, W, H);
  }

  if (id === 'avatar') {
    const smile = calcSmile(bs);
    const ear = (calcEAR(lm,EYE_LEFT)+calcEAR(lm,EYE_RIGHT))/2;
    const mouth = calcMouthOpen(lm);
    const em = mouth > 0.3 ? 'üòÆ' : smile > 0.4 ? 'üòä' : ear < 0.18 ? 'üò¥' : 'üòê';
    setEl('m-avatar-state', em);
    drawAvatarFace(ctx, cvs, lm, W, H, {smile, ear, mouth});
  }

  if (id === 'filter' || id === 'tiktok') {
    applyFilter(ctx, cvs, lm, W, H, id);
  }

  if (id === 'emotion') {
    processEmotion(bs, lm);
  }

  if (id === 'driver') {
    processDriver(lm, bs);
  }

  if (id === 'speech') {
    const mouth = calcMouthOpen(lm) * 100;
    setEl('m-mouth', Math.round(mouth) + '%');
    setBar('b-mouth', mouth);
    const phonemes = ['A','E','I','O','U','M','P','B'];
    if (mouth > 20) setEl('m-phoneme', phonemes[Math.floor(mouth/12.5) % phonemes.length]);
    setEl('m-speech-score', Math.round(70+Math.random()*25) + '%');
    drawMouthBox(ctx, lm, W, H);
  }

  if (id === 'faceauth') {
    drawFaceBox(ctx, lm, W, H, '#00f5ff', 'SCANNING...');
  }

  if (id === 'attendance') {
    setEl('m-faces-count', '1');
    setEl('m-att-id', '1');
    setEl('m-att-stat', 'D√âTECT√â');
    drawFaceBox(ctx, lm, W, H, '#39ff14', 'PR√âSENT ‚úì');
  }
}

// ================================================================
// POSE PROCESSING
// ================================================================
let repCount = 0, setCount = 0, repPhase = 'up', exName = 'üí™ POMPES';
let prevCMY = null;
let calsBurned = 0, calsTimer = null;
let activeSeconds = 0, cardioScore = 0;
let slideNum = 1;
let stretchSeconds = 0, stretchInterval = null;

function getAngle(a, b, c) {
  const ab = {x:a.x-b.x, y:a.y-b.y};
  const cb = {x:c.x-b.x, y:c.y-b.y};
  const dot = ab.x*cb.x + ab.y*cb.y;
  const mag = Math.hypot(ab.x,ab.y) * Math.hypot(cb.x,cb.y);
  return mag > 0 ? Math.round(Math.acos(Math.min(1,Math.max(-1,dot/mag))) * 180/Math.PI) : 0;
}

function processPoseResults(id, ctx, cvs, results) {
  if (!results?.landmarks?.length) {
    drawNobodyText(ctx, cvs);
    return;
  }

  const lm = results.landmarks[0];
  const W = cvs.width, H = cvs.height;

  drawPoseSkeleton(ctx, lm, W, H);

  if (id === 'reps') {
    const angle = exName.includes('SQUAT') 
      ? getAngle(lm[23], lm[25], lm[27])
      : getAngle(lm[11], lm[13], lm[15]);
    
    setEl('m-angle', angle + '¬∞');
    
    const threshold = exName.includes('SQUAT') ? {up:160, down:90} : {up:160, down:70};
    if (repPhase === 'up' && angle < threshold.down) {
      repPhase = 'down';
    } else if (repPhase === 'down' && angle > threshold.up) {
      repPhase = 'up';
      repCount++;
      setEl('m-reps', repCount);
      const el = document.getElementById('m-reps');
      el?.classList.add('bump');
      setTimeout(() => el?.classList.remove('bump'), 250);
      if (repCount % 10 === 0) {
        setCount++;
        setEl('m-sets', setCount);
        toast('üèÜ S√âRIE ' + setCount + ' COMPL√àTE!', 'green');
      }
    }
    const forms = ['EXCELLENTE','PARFAITE','BONNE','OK'];
    setEl('m-form', forms[Math.floor(Math.random()*forms.length)]);
    setStyle('m-form','color','var(--neon-green)');
    
    // Draw angle arc
    drawAngleArc(ctx, lm, W, H, angle, exName);
  }

  if (id === 'squat') {
    const kneeLft = getAngle(lm[23], lm[25], lm[27]);
    const kneeRgt = getAngle(lm[24], lm[26], lm[28]);
    const hipAng  = getAngle(lm[11], lm[23], lm[25]);
    const avgKnee = Math.round((kneeLft + kneeRgt) / 2);

    setEl('m-knee', avgKnee + '¬∞');
    setEl('m-hip', hipAng + '¬∞');
    setBar('b-knee', Math.min(100, avgKnee / 180 * 100));

    const score = Math.min(100, Math.round(
      (avgKnee > 80 && avgKnee < 120 ? 40 : 20) +
      (hipAng > 60 && hipAng < 100 ? 40 : 20) +
      20
    ));
    setEl('m-squat-score', score);
    setStyle('m-squat-score','color', score>70?'var(--neon-green)':score>50?'var(--neon-yellow)':'var(--neon-pink)');

    const phase = avgKnee < 130 ? 'EN BAS üîΩ' : avgKnee < 160 ? 'DESCENTE ‚Üì' : 'DEBOUT ‚Üë';
    setEl('m-squat-phase', phase);
    showAlert('a-squat', kneeLft > 170 && kneeLft < 181);

    drawAngleArc(ctx, lm, W, H, avgKnee, 'SQUAT');
  }

  if (id === 'fall') {
    const cmy = (lm[11].y + lm[12].y + lm[23].y + lm[24].y) / 4;
    const vel = prevCMY !== null ? Math.abs(cmy - prevCMY) * 1000 : 0;
    prevCMY = cmy;

    setEl('m-cmy', cmy.toFixed(3));
    setEl('m-fall-vel', Math.round(vel) + 'px/s');
    setBar('b-cmy', cmy * 100);

    const fell = vel > 0.15 && cmy > 0.7;
    setEl('m-fall-stat', fell ? '‚ö† CHUTE!' : 'STABLE ‚úì');
    setStyle('m-fall-stat','color', fell?'var(--neon-pink)':'var(--neon-green)');
    showAlert('a-fall', fell);
    if (fell) toast('üö® CHUTE D√âTECT√âE!', 'pink');
  }

  if (id === 'slides') {
    const lWrist = lm[15], rWrist = lm[16];
    const lShoulder = lm[11], rShoulder = lm[12];
    const lRaised = lWrist.y < lShoulder.y - 0.1;
    const rRaised = rWrist.y < rShoulder.y - 0.1;

    let gest = 'EN ATTENTE';
    if (lRaised && rRaised) { gest = '‚è∏ PAUSE'; }
    else if (rRaised) { gest = '‚ñ∂ SUIVANT'; if (Math.random()<0.02) { slideNum=Math.min(12,slideNum+1); setEl('m-slide-n',slideNum); toast('‚ñ∂ Diapo '+slideNum,'green'); } }
    else if (lRaised) { gest = '‚óÄ PR√âC√âDENT'; if (Math.random()<0.02) { slideNum=Math.max(1,slideNum-1); setEl('m-slide-n',slideNum); toast('‚óÄ Diapo '+slideNum); } }
    setEl('m-slide-gest', gest);
    drawSlideGuide(ctx, lm, W, H, lRaised, rRaised);
  }

  if (id === 'calories') {
    const motion = calcBodyMotion(lm);
    calsBurned += motion * 0.001;
    setEl('m-cals', Math.round(calsBurned));
    const intensity = motion > 0.05 ? '√âLEV√âE' : motion > 0.02 ? 'MOD√âR√âE' : 'FAIBLE';
    setEl('m-intensity', intensity);
    setBar('b-intensity', Math.min(100, motion * 2000));
  }

  if (id === 'cardio') {
    const motion = calcBodyMotion(lm);
    cardioScore = Math.min(10, Math.round(motion * 200));
    setEl('m-cardio', cardioScore);
    setEl('m-move', motion > 0.05 ? 'ACTIF üèÉ' : motion > 0.01 ? 'L√âGER üö∂' : 'IMMOBILE');
  }

  if (id === 'yoga') {
    const poses = processYogaPose(lm);
    setEl('m-yoga-pose', poses.name);
    setEl('m-yoga-score', poses.score);
    setStyle('m-yoga-score','color', poses.score>70?'var(--neon-green)':poses.score>50?'var(--neon-yellow)':'var(--neon-pink)');
    const lFoot = lm[31], rFoot = lm[32];
    const balance = Math.abs(lFoot.y - rFoot.y) < 0.05 ? 'STABLE ‚úì' : 'INSTABLE ‚ö†';
    setEl('m-balance', balance);
  }

  if (id === 'ergo') {
    const lSh = lm[11], rSh = lm[12];
    const shDiff = Math.abs(lSh.y - rSh.y);
    const backStraight = shDiff < 0.05;
    const score = Math.round((backStraight ? 60 : 30) + Math.random() * 20 + 20);
    setEl('m-ergo-score', score);
    setEl('m-shoulders', shDiff < 0.05 ? 'NIVEAU ‚úì' : 'IN√âGALES ‚ö†');
    setStyle('m-shoulders','color', shDiff<0.05?'var(--neon-green)':'var(--neon-yellow)');
    setEl('m-back', backStraight ? 'DROIT ‚úì' : 'COURB√â ‚ö†');
    setStyle('m-back','color', backStraight?'var(--neon-green)':'var(--neon-yellow)');
    showAlert('a-ergo', !backStraight);
  }

  if (id === 'clothes') {
    drawClothesOverlay(ctx, lm, W, H);
  }

  if (id === 'security') {
    const headTop = lm[0].y;
    const hasHelmet = headTop < 0.3;
    setEl('m-helmet', hasHelmet ? 'PORT√â ‚úì' : 'ABSENT ‚úó');
    setStyle('m-helmet','color', hasHelmet?'var(--neon-green)':'var(--neon-pink)');
    const conform = hasHelmet;
    setEl('m-epi', conform ? 'CONFORME ‚úì' : 'NON-CONFORME ‚úó');
    setStyle('m-epi','color', conform?'var(--neon-green)':'var(--neon-pink)');
    showAlert('a-security', !conform);
  }

  if (id === 'stretch') {
    const angle = getAngle(lm[11], lm[23], lm[25]);
    setEl('m-stretch-name', angle < 120 ? 'FLEXION HANCHE' : 'EXTENSION');
    setBar('b-stretch', Math.min(100, stretchSeconds / 30 * 100));
  }

  if (id === 'dance') {
    const sync = Math.floor(Math.random() * 40 + 60);
    setEl('m-sync', sync + '%');
    setBar('b-sync', sync);
    const combo = Math.floor(Math.random() * 10);
    setEl('m-combo', 'x' + combo);
    const dScore = parseInt(document.getElementById('m-dance-score')?.textContent || '0') + (sync > 80 ? 10 : 5);
    setEl('m-dance-score', Math.min(9999, dScore));
  }
}

// ================================================================
// HAND PROCESSING
// ================================================================
let paintPoints = [];
let paintColor = '#00f5ff';
let paintPointsCount = 0;
let djPos = {y: 0.5};
let keyTyped = '';

function processHandResults(id, ctx, cvs, results) {
  if (!results?.landmarks?.length) {
    drawNobodyText(ctx, cvs);
    return;
  }

  const hands = results.landmarks;
  const W = cvs.width, H = cvs.height;

  hands.forEach(lm => drawHandSkeleton(ctx, lm, W, H));

  const lm = hands[0];
  const tip = lm[8]; // index finger tip
  const conf = Math.round(85 + Math.random() * 13);

  if (id === 'holo') {
    const gesture = detectGesture(lm);
    setEl('m-gest', gesture.icon);
    setEl('m-hand-conf', conf + '%');
    setBar('b-hand-conf', conf);
    if (gesture.action) {
      const acts = parseInt(document.getElementById('m-holo-acts')?.textContent||'0');
      setEl('m-holo-acts', acts + 1);
    }
    drawHoloUI(ctx, cvs, lm, W, H);
  }

  if (id === 'paint') {
    const extra = document.getElementById('extra-cvs-paint');
    if (extra) {
      const ectx = extra.getContext('2d');
      const tipX = (1 - tip.x) * W;
      const tipY = tip.y * H;
      
      paintPoints.push({x:tipX, y:tipY, c:paintColor});
      if (paintPoints.length > 2) {
        ectx.globalCompositeOperation = 'source-over';
        ectx.strokeStyle = paintColor;
        ectx.lineWidth = 6;
        ectx.lineCap = 'round';
        ectx.shadowBlur = 20;
        ectx.shadowColor = paintColor;
        ectx.beginPath();
        const prev = paintPoints[paintPoints.length - 2];
        ectx.moveTo(prev.x, prev.y);
        ectx.lineTo(tipX, tipY);
        ectx.stroke();
        paintPointsCount++;
        setEl('m-paint-pts', paintPointsCount);
      }
      // Fade effect
      ectx.globalCompositeOperation = 'destination-out';
      ectx.fillStyle = 'rgba(0,0,0,0.005)';
      ectx.fillRect(0,0,W,H);
      ectx.globalCompositeOperation = 'source-over';
    }
    // Draw cursor dot
    ctx.beginPath();
    ctx.arc(tip.x*W, tip.y*H, 8, 0, Math.PI*2);
    ctx.fillStyle = paintColor;
    ctx.shadowBlur = 20;
    ctx.shadowColor = paintColor;
    ctx.fill();
    ctx.shadowBlur = 0;
  }

  if (id === 'keyboard') {
    const extra = document.getElementById('extra-cvs-keyboard');
    drawVirtualKeyboard(ctx, cvs, lm, W, H);
  }

  if (id === 'dj') {
    const handY = (lm[9].y + lm[0].y) / 2;
    const vol = Math.round((1 - handY) * 100);
    const bass = Math.round(Math.abs(lm[8].x - lm[4].x) * 300);
    const treble = Math.round(lm[8].y * 100);

    setEl('m-bpm', 80 + Math.floor(lm[8].x * 160));
    const volPct = Math.min(100, Math.max(0, vol));
    setBar('dj-vol', volPct);
    setEl('dj-vol-v', volPct + '%');
    const bassPct = Math.min(100, bass);
    setBar('dj-bass', bassPct);
    setEl('dj-bass-v', bassPct + '%');
    const trPct = Math.min(100, 100-treble);
    setBar('dj-treble', trPct);
    setEl('dj-treble-v', trPct + '%');

    const gname = detectGesture(lm);
    setEl('m-dj-gest', gname.name);
    setStyle('m-dj-gest','color','var(--neon-pink)');
    drawDJOverlay(ctx, lm, W, H, volPct);
  }

  if (id === 'guitar') {
    const strum = detectStrum(lm);
    const chord = detectChord(lm);
    setEl('m-chord', chord);
    setEl('m-strum', strum > 0.3 ? 'STRUMMING üé∏' : 'SILENCE');
    setBar('b-strum', strum * 100);
    if (strum > 0.5) {
      const notes = parseInt(document.getElementById('m-notes')?.textContent||'0');
      setEl('m-notes', notes + 1);
    }
    drawGuitarOverlay(ctx, lm, W, H, chord, strum);
  }
}

// ================================================================
// GESTURE DETECTION
// ================================================================
function detectGesture(lm) {
  const fingers = [8,12,16,20].map(i => lm[i].y < lm[i-2].y);
  const thumbUp = lm[4].x < lm[3].x;
  
  if (fingers.every(f=>f)) return {icon:'üñê',name:'MAIN OUVERTE',action:false};
  if (!fingers.every(f=>!f) && fingers[0] && fingers[1] && !fingers[2] && !fingers[3]) return {icon:'‚úå',name:'VICTOIRE',action:true};
  if (fingers[0] && !fingers[1] && !fingers[2] && !fingers[3]) return {icon:'üëÜ',name:'POINTER',action:true};
  if (!fingers.some(f=>f) && thumbUp) return {icon:'üëç',name:'POUCE HAUT',action:false};
  if (!fingers.some(f=>f)) return {icon:'‚úä',name:'POING',action:false};
  return {icon:'ü§ö',name:'NEUTRE',action:false};
}

function detectStrum(lm) {
  return Math.abs(lm[8].y - lm[12].y) + Math.abs(lm[12].y - lm[16].y);
}

function detectChord(lm) {
  const chords = ['Am','C','G','D','Em','F','Bm','E'];
  const idx = Math.floor(lm[4].x * chords.length);
  return chords[Math.min(chords.length-1, Math.max(0, idx))];
}

// ================================================================
// DRAWING UTILITIES
// ================================================================
function drawFaceOutline(ctx, lm, W, H) {
  const outline = [10,338,297,332,284,251,389,356,454,323,361,288,397,365,379,378,400,377,152,148,176,149,150,136,172,58,132,93,234,127,162,21,54,103,67,109,10];
  ctx.beginPath();
  outline.forEach((i,j) => {
    const x = lm[i].x*W, y = lm[i].y*H;
    j===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  });
  ctx.closePath();
  ctx.strokeStyle = 'rgba(0,245,255,0.5)';
  ctx.lineWidth = 1.5;
  ctx.stroke();
}

function drawFaceMesh(ctx, lm, W, H) {
  const mp = resolveMP();
  const FL = mp?.FaceLandmarker;
  const connections = FL?.FACE_LANDMARKS_TESSELATION || [];
  ctx.strokeStyle = 'rgba(0,245,255,0.15)';
  ctx.lineWidth = 0.5;
  connections.forEach(c => {
    ctx.beginPath();
    ctx.moveTo(lm[c.start].x*W, lm[c.start].y*H);
    ctx.lineTo(lm[c.end].x*W, lm[c.end].y*H);
    ctx.stroke();
  });
}

function drawEyeBox(ctx, lm, W, H, color) {
  const eyes = [EYE_LEFT, EYE_RIGHT];
  eyes.forEach(eye => {
    const pts = eye.map(i => ({x:lm[i].x*W, y:lm[i].y*H}));
    ctx.beginPath();
    pts.forEach((p,j) => j===0 ? ctx.moveTo(p.x,p.y) : ctx.lineTo(p.x,p.y));
    ctx.closePath();
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.shadowBlur = 8;
    ctx.shadowColor = color;
    ctx.stroke();
    ctx.shadowBlur = 0;
  });
}

function drawSmileBox(ctx, lm, W, H, pct, color) {
  const mouthPts = [61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146,61];
  ctx.beginPath();
  mouthPts.forEach((i,j) => {
    const x=lm[i].x*W, y=lm[i].y*H;
    j===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.closePath();
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.shadowBlur = 10;
  ctx.shadowColor = color;
  ctx.stroke();
  ctx.shadowBlur = 0;
  
  // Score label
  const nx = lm[1].x*W, ny = lm[1].y*H - 20;
  ctx.fillStyle = color;
  ctx.font = 'bold 13px Orbitron,monospace';
  ctx.fillText('SMILE: ' + pct + '%', nx - 40, ny);
}

function drawFaceBox(ctx, lm, W, H, color, label) {
  const minX = Math.min(...lm.map(p=>p.x*W));
  const maxX = Math.max(...lm.map(p=>p.x*W));
  const minY = Math.min(...lm.map(p=>p.y*H));
  const maxY = Math.max(...lm.map(p=>p.y*H));
  ctx.strokeStyle = color; ctx.lineWidth = 2;
  ctx.shadowBlur = 15; ctx.shadowColor = color;
  ctx.strokeRect(minX-10, minY-10, maxX-minX+20, maxY-minY+20);
  ctx.shadowBlur = 0;
  ctx.fillStyle = color; ctx.font = '11px Share Tech Mono,monospace';
  ctx.fillText(label, minX-10, minY-15);
}

function drawHeadAxis(ctx, lm, W, H, hp) {
  const noseTip = {x:lm[1].x*W, y:lm[1].y*H};
  ctx.strokeStyle = 'rgba(0,245,255,0.8)'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(noseTip.x, noseTip.y);
  ctx.lineTo(noseTip.x, noseTip.y - 60); ctx.stroke();
  ctx.strokeStyle = 'rgba(255,0,110,0.8)';
  ctx.beginPath(); ctx.moveTo(noseTip.x, noseTip.y);
  ctx.lineTo(noseTip.x + hp.yaw, noseTip.y); ctx.stroke();
}

function drawMouthBox(ctx, lm, W, H) {
  const mouthCenter = {x:lm[13].x*W, y:lm[13].y*H};
  ctx.beginPath();
  ctx.arc(mouthCenter.x, mouthCenter.y, 30, 0, Math.PI*2);
  ctx.strokeStyle = 'rgba(0,245,255,0.6)'; ctx.lineWidth = 2;
  ctx.stroke();
}

function placeARItem(lm, W, H) {
  const arEl = document.getElementById('ar-item');
  if (!arEl) return;
  const noseTop = lm[168];
  const lEye = lm[33], rEye = lm[263];
  const eyeW = Math.hypot((lEye.x-rEye.x)*W, (lEye.y-rEye.y)*H);
  const cx = (lEye.x+rEye.x)/2 * W;
  const cy = ((lEye.y+rEye.y)/2) * H;
  const cb = document.getElementById('cb-arglasses');
  if (!cb) return;
  const rect = cb.getBoundingClientRect();
  const scaleX = rect.width / W, scaleY = rect.height / H;
  arEl.style.display = 'block';
  arEl.style.left = (cx * scaleX - eyeW * scaleX) + 'px';
  arEl.style.top  = (cy * scaleY - 20) + 'px';
  arEl.style.fontSize = Math.max(24, eyeW * scaleX * 0.9) + 'px';
}

function drawAvatarFace(ctx, cvs, lm, W, H, {smile, ear, mouth}) {
  const cx = lm[1].x*W, cy = lm[1].y*H;
  const size = Math.hypot((lm[33].x-lm[263].x)*W, 0) * 1.5;
  
  ctx.save();
  ctx.translate(cx, cy);
  
  // Face
  ctx.beginPath();
  ctx.arc(0, 0, size, 0, Math.PI*2);
  ctx.fillStyle = 'rgba(0,245,255,0.15)';
  ctx.fill();
  ctx.strokeStyle = 'rgba(0,245,255,0.6)';
  ctx.lineWidth = 2;
  ctx.stroke();
  
  // Eyes
  const eyeOpen = ear > 0.20 ? size*0.12 : size*0.02;
  [-size*0.3, size*0.3].forEach(ex => {
    ctx.beginPath();
    ctx.ellipse(ex, -size*0.15, size*0.12, eyeOpen, 0, 0, Math.PI*2);
    ctx.fillStyle = ear > 0.20 ? 'rgba(0,245,255,0.8)' : 'rgba(0,245,255,0.3)';
    ctx.fill();
  });
  
  // Mouth
  const smileW = size * (0.3 + smile * 0.3);
  ctx.beginPath();
  ctx.moveTo(-smileW, size*0.2);
  ctx.quadraticCurveTo(0, size*(0.2 + smile*0.25 + mouth*0.2), smileW, size*0.2);
  ctx.strokeStyle = 'rgba(0,245,255,0.8)';
  ctx.lineWidth = 3;
  ctx.stroke();
  
  ctx.restore();
}

function applyFilter(ctx, cvs, lm, W, H, id) {
  const filters = ['rainbow','ghost','neon','matrix'];
  const f = filters[Math.floor(Date.now()/3000) % filters.length];
  setEl('m-filter-name', f.toUpperCase());
  
  if (f === 'neon') {
    ctx.globalCompositeOperation = 'screen';
    ctx.fillStyle = 'rgba(0,245,255,0.15)';
    ctx.fillRect(0,0,W,H);
    ctx.globalCompositeOperation = 'source-over';
  } else if (f === 'rainbow') {
    const g = ctx.createLinearGradient(0,0,W,H);
    g.addColorStop(0,'rgba(255,0,0,0.1)');
    g.addColorStop(0.3,'rgba(0,255,0,0.1)');
    g.addColorStop(0.6,'rgba(0,0,255,0.1)');
    g.addColorStop(1,'rgba(255,0,255,0.1)');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);
  }
  drawFaceOutline(ctx, lm, W, H);
}

function processEmotion(bs, lm) {
  if (!bs?.length) return;
  const categories = bs[0]?.categories || [];
  const get = name => categories.find(c=>c.categoryName===name)?.score || 0;
  
  const happy = get('mouthSmileLeft') + get('mouthSmileRight');
  const sad   = get('browDownLeft') + get('browDownRight');
  const surprised = get('eyeWideLeft') + get('eyeWideRight');
  const angry  = get('browInnerUp') * 2;
  const mouth  = get('mouthOpen');
  
  const scores = [
    {id:'ec-happy', score:happy, e:'üòä', n:'HEUREUX'},
    {id:'ec-sad', score:sad, e:'üò¢', n:'TRISTE'},
    {id:'ec-stress', score:angry*0.7+sad*0.3, e:'üò§', n:'STRESS√â'},
    {id:'ec-surprised', score:surprised, e:'üò≤', n:'SURPRIS'},
    {id:'ec-neutral', score:0.3, e:'üòê', n:'NEUTRE'},
    {id:'ec-angry', score:angry, e:'üò†', n:'COL√àRE'},
  ];
  
  const best = scores.reduce((a,b) => a.score>b.score?a:b);
  setEl('m-emo-icon', best.e);
  setEl('m-emo-name', best.n);
  const conf = Math.round(50 + best.score * 50);
  setEl('m-emo-conf', conf + '%');
  setBar('b-emo', conf);
  
  scores.forEach(s => {
    const el = document.getElementById(s.id);
    if (el) el.className = 'emo-chip' + (s.id===best.id?' on':'');
  });
}

function processDriver(lm, bs) {
  const ear = (calcEAR(lm,EYE_LEFT)+calcEAR(lm,EYE_RIGHT))/2;
  const hp  = getHeadPose(lm);
  const looking = Math.abs(hp.yaw) > 25 || Math.abs(hp.pitch) > 20;
  const drowsy = ear < 0.22 ? 80 : 20;

  setEl('m-gaze', looking ? 'DISTRAIT ‚úó' : 'ROUTE ‚úì');
  setStyle('m-gaze','color', looking?'var(--neon-pink)':'var(--neon-green)');
  setEl('m-drows', drowsy + '%');
  setBar('b-drows', drowsy);
  showAlert('a-driver', looking || drowsy > 70);

  if (calcMouthOpen(lm) > 0.5) {
    const y = parseInt(document.getElementById('m-yawn')?.textContent||'0');
    if (Math.random() < 0.05) setEl('m-yawn', y+1);
  }
}

function processYogaPose(lm) {
  const lKnee = getAngle(lm[23],lm[25],lm[27]);
  const rKnee = getAngle(lm[24],lm[26],lm[28]);
  const torso = getAngle(lm[11],lm[23],lm[25]);
  
  const poses = [
    {name:'GUERRIER I üßò',cond: lKnee<120&&rKnee>160,score:85},
    {name:'ARBRE üå≤',cond: Math.abs(lm[27].x-lm[28].x)<0.05,score:90},
    {name:'CHIEN T√äTE EN BAS',cond: torso<60,score:80},
    {name:'DEBOUT',cond:true,score:70},
  ];
  return poses.find(p=>p.cond) || poses[poses.length-1];
}

function calcBodyMotion(lm) {
  // Rough motion metric from limb positions
  const limbs = [lm[15],lm[16],lm[27],lm[28]];
  let motion = 0;
  limbs.forEach(p => motion += Math.abs(p.x-0.5) + Math.abs(p.y-0.5));
  return motion / limbs.length;
}

function drawPoseSkeleton(ctx, lm, W, H) {
  const mp = resolveMP();
  const PL = mp?.PoseLandmarker;
  const connections = PL?.POSE_CONNECTIONS || [
    {start:11,end:12},{start:11,end:13},{start:13,end:15},
    {start:12,end:14},{start:14,end:16},{start:11,end:23},
    {start:12,end:24},{start:23,end:24},{start:23,end:25},
    {start:24,end:26},{start:25,end:27},{start:26,end:28},
    {start:27,end:29},{start:28,end:30},{start:29,end:31},{start:30,end:32}
  ];
  
  ctx.strokeStyle = 'rgba(255,0,110,0.8)'; ctx.lineWidth = 2.5;
  connections.forEach(c => {
    if (!lm[c.start]||!lm[c.end]) return;
    ctx.beginPath();
    ctx.moveTo(lm[c.start].x*W, lm[c.start].y*H);
    ctx.lineTo(lm[c.end].x*W, lm[c.end].y*H);
    ctx.stroke();
  });
  
  // Joints
  [11,12,13,14,15,16,23,24,25,26,27,28].forEach(i => {
    if (!lm[i]) return;
    ctx.beginPath();
    ctx.arc(lm[i].x*W, lm[i].y*H, 4, 0, Math.PI*2);
    ctx.fillStyle = '#ff006e';
    ctx.shadowBlur = 8; ctx.shadowColor = '#ff006e';
    ctx.fill();
    ctx.shadowBlur = 0;
  });
}

function drawAngleArc(ctx, lm, W, H, angle, type) {
  const isSquat = type === 'SQUAT' || type.includes('SQUAT');
  const joint = isSquat ? lm[25] : lm[13];
  if (!joint) return;
  const x = joint.x*W, y = joint.y*H;
  
  const color = angle < 100 ? '#39ff14' : angle < 140 ? '#ffe000' : '#ff006e';
  ctx.beginPath();
  ctx.arc(x, y, 30, 0, (angle/360)*Math.PI*2);
  ctx.strokeStyle = color; ctx.lineWidth = 3;
  ctx.shadowBlur = 10; ctx.shadowColor = color;
  ctx.stroke(); ctx.shadowBlur = 0;
  
  ctx.fillStyle = color; ctx.font = 'bold 12px Orbitron,monospace';
  ctx.fillText(angle + '¬∞', x + 35, y);
}

function drawHandSkeleton(ctx, lm, W, H) {
  const connections = [
    [0,1],[1,2],[2,3],[3,4],
    [0,5],[5,6],[6,7],[7,8],
    [0,9],[9,10],[10,11],[11,12],
    [0,13],[13,14],[14,15],[15,16],
    [0,17],[17,18],[18,19],[19,20],
    [5,9],[9,13],[13,17]
  ];
  ctx.strokeStyle = 'rgba(57,255,20,0.7)'; ctx.lineWidth = 2;
  connections.forEach(([a,b]) => {
    ctx.beginPath();
    ctx.moveTo(lm[a].x*W, lm[a].y*H);
    ctx.lineTo(lm[b].x*W, lm[b].y*H);
    ctx.stroke();
  });
  lm.forEach((p,i) => {
    ctx.beginPath();
    ctx.arc(p.x*W, p.y*H, i===0?5:3, 0, Math.PI*2);
    ctx.fillStyle = '#39ff14';
    ctx.shadowBlur = 6; ctx.shadowColor = '#39ff14';
    ctx.fill(); ctx.shadowBlur = 0;
  });
}

function drawHoloUI(ctx, cvs, lm, W, H) {
  const tip = lm[8];
  const tx = tip.x*W, ty = tip.y*H;
  
  // Cursor
  ctx.beginPath();
  ctx.arc(tx, ty, 10, 0, Math.PI*2);
  ctx.strokeStyle = 'rgba(0,245,255,0.8)'; ctx.lineWidth = 2;
  ctx.shadowBlur = 15; ctx.shadowColor = 'var(--neon-cyan)';
  ctx.stroke(); ctx.shadowBlur = 0;
  
  // Holo buttons
  const btns = ['‚ñ∑ PLAY','‚óª MENU','‚úï CLOSE'];
  btns.forEach((t,i) => {
    const bx = 20, by = H*0.25 + i*50;
    const hover = tx<bx+100&&tx>bx&&ty>by&&ty<by+35;
    ctx.strokeStyle = hover ? '#00f5ff' : 'rgba(0,245,255,0.4)';
    ctx.lineWidth = 1;
    ctx.strokeRect(bx, by, 100, 35);
    ctx.fillStyle = hover ? 'rgba(0,245,255,0.2)' : 'rgba(0,245,255,0.05)';
    ctx.fillRect(bx, by, 100, 35);
    ctx.fillStyle = hover ? '#00f5ff' : 'rgba(0,245,255,0.6)';
    ctx.font = '11px Share Tech Mono,monospace';
    ctx.fillText(t, bx+8, by+22);
  });
}

function drawVirtualKeyboard(ctx, cvs, lm, W, H) {
  const rows = [
    ['Q','W','E','R','T','Y','U','I','O','P'],
    ['A','S','D','F','G','H','J','K','L'],
    ['Z','X','C','V','B','N','M','‚å´'],
  ];
  const startY = H - 130;
  const tip = lm[8];
  const tx = tip.x*W, ty = tip.y*H;
  let pressedKey = null;

  rows.forEach((row, ri) => {
    const kw = 34, kh = 30, gap = 3;
    const totalW = row.length * (kw + gap);
    const startX = (W - totalW) / 2;
    row.forEach((k, ci) => {
      const kx = startX + ci*(kw+gap), ky = startY + ri*(kh+gap);
      const hover = tx>kx&&tx<kx+kw&&ty>ky&&ty<ky+kh;
      ctx.fillStyle = hover ? 'rgba(0,245,255,0.4)' : 'rgba(0,245,255,0.08)';
      ctx.fillRect(kx,ky,kw,kh);
      ctx.strokeStyle = hover ? 'rgba(0,245,255,0.9)' : 'rgba(0,245,255,0.3)';
      ctx.lineWidth = 1;
      ctx.strokeRect(kx,ky,kw,kh);
      ctx.fillStyle = hover ? '#fff' : 'rgba(0,245,255,0.8)';
      ctx.font = '11px Share Tech Mono,monospace';
      ctx.textAlign = 'center';
      ctx.fillText(k, kx+kw/2, ky+kh/2+4);
      ctx.textAlign = 'left';
      if (hover && lm[8].z < -0.05 && Math.random() < 0.05) {
        pressedKey = k;
      }
    });
  });
  
  if (pressedKey) {
    setEl('m-key-last', pressedKey);
    const el = document.getElementById('m-key-text');
    if (el) {
      if (pressedKey === '‚å´') el.textContent = el.textContent.slice(0,-1);
      else el.textContent += pressedKey;
    }
  }
  
  // Cursor
  ctx.beginPath();
  ctx.arc(tx, ty, 8, 0, Math.PI*2);
  ctx.fillStyle = 'rgba(0,245,255,0.6)';
  ctx.shadowBlur = 12; ctx.shadowColor = '#00f5ff';
  ctx.fill(); ctx.shadowBlur = 0;
}

function drawSlideGuide(ctx, lm, W, H, lRaised, rRaised) {
  if (rRaised) {
    ctx.fillStyle = 'rgba(0,245,255,0.8)';
    ctx.font = 'bold 24px Orbitron,monospace';
    ctx.fillText('‚ñ∂‚ñ∂', W-80, 40);
  }
  if (lRaised) {
    ctx.fillStyle = 'rgba(255,0,110,0.8)';
    ctx.font = 'bold 24px Orbitron,monospace';
    ctx.fillText('‚óÄ‚óÄ', 20, 40);
  }
}

function drawClothesOverlay(ctx, lm, W, H) {
  const ls = lm[11], rs = lm[12], lh = lm[23], rh = lm[24];
  const cx = (ls.x+rs.x)*W/2;
  const topY = Math.min(ls.y, rs.y)*H;
  const botY = Math.max(lh.y, rh.y)*H;
  const bodyW = Math.abs((ls.x-rs.x)*W);

  const item = document.getElementById('m-cloth-item')?.textContent || 'üëï';
  ctx.font = Math.max(40, bodyW) + 'px serif';
  ctx.textAlign = 'center';
  ctx.fillText(item, cx, topY + (botY-topY)*0.6);
  ctx.textAlign = 'left';
}

function drawDJOverlay(ctx, lm, W, H, vol) {
  const cx = lm[9].x*W, cy = lm[9].y*H;
  ctx.beginPath();
  ctx.arc(cx, cy, 30, 0, Math.PI*2);
  ctx.strokeStyle = `hsl(${vol*3},100%,60%)`;
  ctx.lineWidth = 3;
  ctx.shadowBlur = 20; ctx.shadowColor = `hsl(${vol*3},100%,60%)`;
  ctx.stroke(); ctx.shadowBlur = 0;
  ctx.fillStyle = `hsl(${vol*3},100%,60%)`;
  ctx.font = '10px Share Tech Mono';
  ctx.fillText('VOL '+vol+'%', cx-20, cy-35);
}

function drawGuitarOverlay(ctx, lm, W, H, chord, strum) {
  const x = lm[0].x*W, y = lm[0].y*H;
  if (strum > 0.3) {
    ctx.fillStyle = 'rgba(255,224,0,0.9)';
    ctx.font = 'bold 28px Orbitron,monospace';
    ctx.fillText('üé∏ ' + chord, x-30, y-40);
    ctx.beginPath();
    for (let i=0;i<5;i++) {
      ctx.moveTo(x, y);
      ctx.lineTo(x + Math.random()*100-50, y + Math.random()*100-50);
    }
    ctx.strokeStyle = 'rgba(255,224,0,0.6)'; ctx.lineWidth = 1;
    ctx.stroke();
  }
}

function drawNobodyText(ctx, cvs) {
  ctx.fillStyle = 'rgba(0,245,255,0.3)';
  ctx.font = '13px Share Tech Mono,monospace';
  ctx.textAlign = 'center';
  ctx.fillText('AUCUNE PERSONNE D√âTECT√âE', cvs.width/2, cvs.height/2);
  ctx.textAlign = 'left';
}

function drawFallbackOverlay(ctx, cvs, id) {
  ctx.fillStyle = 'rgba(0,245,255,0.08)';
  ctx.fillRect(0, 0, cvs.width, cvs.height);
  ctx.strokeStyle = 'rgba(0,245,255,0.3)';
  ctx.lineWidth = 1;
  const cx = cvs.width/2, cy = cvs.height/2;
  ctx.beginPath(); ctx.arc(cx, cy, 80, 0, Math.PI*2); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx-100,cy); ctx.lineTo(cx+100,cy); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx,cy-100); ctx.lineTo(cx,cy+100); ctx.stroke();
  ctx.fillStyle = 'rgba(0,245,255,0.5)';
  ctx.font = '11px Share Tech Mono';
  ctx.textAlign = 'center';
  ctx.fillText('MODE SIMULATION ¬∑ MOD√àLE EN CHARGEMENT', cx, cvs.height-20);
  ctx.textAlign = 'left';
  runSimMetrics(id);
}

// ================================================================
// SIMULATION MODE (when camera not available)
// ================================================================
let simModeInterval = null;

function runSimMode(id) {
  toast('‚ö† Mode simulation (sans cam√©ra)', 'yellow');
  simModeInterval = setInterval(() => {
    runSimMetrics(id);
  }, 500);
}

function runSimMetrics(id) {
  const rand = () => Math.random();
  if (id==='fatigue') { const e=(0.15+rand()*0.2); setEl('m-ear',e.toFixed(3)); setBar('b-ear',e*250); }
  if (id==='blink') { setEl('m-blink-rate',Math.floor(10+rand()*15)); }
  if (id==='headpose') { setEl('m-pitch',Math.floor(rand()*30-15)+'¬∞'); setEl('m-yaw',Math.floor(rand()*40-20)+'¬∞'); }
  if (id==='emotion') { const emos=['üòäüò¢üò§üò≤üòêüò†'.split('')]; setEl('m-emo-icon',['üòä','üò¢','üò§','üò≤','üòê','üò†'][Math.floor(rand()*6)]); }
  if (id==='reps') { setEl('m-angle',Math.floor(80+rand()*100)+'¬∞'); }
  if (id==='dj') { setBar('dj-vol',Math.floor(rand()*100)); }
}

// ================================================================
// HELPER FUNCTIONS
// ================================================================
function setEl(id, val) {
  const el = document.getElementById(id);
  if (!el) return;
  if (el.textContent !== String(val)) {
    el.textContent = val;
    // Flash only for metric values (not breadcrumb/status text)
    if (el.classList.contains('met-val')) {
      el.classList.remove('flash');
      void el.offsetWidth;
      el.classList.add('flash');
    }
  }
}

function setBar(id, pct) {
  const el = document.getElementById(id);
  if (el) el.style.width = Math.min(100, Math.max(0, pct)) + '%';
}

function setStyle(id, prop, val) {
  const el = document.getElementById(id);
  if (el) el.style[prop] = val;
}

function showAlert(id, show) {
  const el = document.getElementById(id);
  if (el) el.className = el.className.replace(' show','') + (show?' show':'');
}

// ================================================================
// SIMULATION TRIGGERS
// ================================================================
function simFatigue() { eyesClosedStart = Date.now() - 2500; toast('‚ö† Fatigue simul√©e','pink'); }
function simSmile() { smileCooldown = 0; const sm=0.8; setEl('m-smile',Math.round(sm*100)+'%'); setBar('b-smile',sm*100); smilePhotosCount++; setEl('m-photos',smilePhotosCount); showAlert('a-smile',true); setTimeout(()=>showAlert('a-smile',false),2000); toast('üì∏ Sourire simul√©!','green'); }
function simEmotion() { const emS=[{icon:'üòä',name:'HEUREUX',id:'ec-happy'},{icon:'üò¢',name:'TRISTE',id:'ec-sad'},{icon:'üò§',name:'STRESS√â',id:'ec-stress'}]; const e=emS[Math.floor(Math.random()*emS.length)]; setEl('m-emo-icon',e.icon); setEl('m-emo-name',e.name); setEl('m-emo-conf',Math.floor(70+Math.random()*25)+'%'); toast('üß† '+e.name,'green'); }
function simSecAlert() { const on=document.getElementById('m-epi')?.textContent.includes('NON'); setEl('m-epi',on?'CONFORME ‚úì':'NON-CONFORME ‚úó'); setStyle('m-epi','color',on?'var(--neon-green)':'var(--neon-pink)'); setEl('m-helmet',on?'PORT√â ‚úì':'ABSENT ‚úó'); setStyle('m-helmet','color',on?'var(--neon-green)':'var(--neon-pink)'); showAlert('a-security',!on); if(!on){const a=parseInt(document.getElementById('m-sec-alerts')?.textContent||'0');setEl('m-sec-alerts',a+1);toast('üö® ALERTE EPI!','pink');} }
function simDriver() { const d=Math.random()>0.5; setEl('m-gaze',d?'DISTRAIT ‚úó':'ROUTE ‚úì'); setStyle('m-gaze','color',d?'var(--neon-pink)':'var(--neon-green)'); setEl('m-drows',d?'75%':'15%'); showAlert('a-driver',d); if(d)toast('üöó Distraction!','pink'); }
function simHolo() { const gs=['‚úã','‚úå','üëÜ','ü§ô','üëç','üëä']; let i=0; const t=setInterval(()=>{setEl('m-gest',gs[i%gs.length]);i++;if(i>gs.length*2)clearInterval(t);},500); toast('üåê UI hologramme activ√©e','green'); }
function simDJ() { setBar('dj-vol',Math.floor(Math.random()*100)); setBar('dj-bass',Math.floor(Math.random()*100)); setBar('dj-treble',Math.floor(Math.random()*100)); setEl('m-bpm',80+Math.floor(Math.random()*120)); setEl('m-dj-gest','SCRATCH üéß'); toast('üéß Mix simul√©','green'); }
function simFall() { showAlert('a-fall',true); setEl('m-fall-stat','‚ö† CHUTE!'); setStyle('m-fall-stat','color','var(--neon-pink)'); setEl('m-fall-vel','450px/s'); setTimeout(()=>{showAlert('a-fall',false);setEl('m-fall-stat','STABLE ‚úì');setStyle('m-fall-stat','color','var(--neon-green)');},3000); toast('üö® CHUTE SIMUL√âE!','pink'); }
function simSquat() { let a=180; const t=setInterval(()=>{a=a>80?a-5:180; setEl('m-knee',a+'¬∞'); setBar('b-knee',a/180*100); const s=a<120&&a>80?95:70; setEl('m-squat-score',s); setEl('m-squat-phase',a<120?'EN BAS üîΩ':'DEBOUT ‚Üë');},100); setTimeout(()=>clearInterval(t),5000); toast('ü¶µ Squat simul√©','green'); }
function simSlide() { slideNum=Math.min(12,slideNum+1); setEl('m-slide-n',slideNum); setEl('m-slide-gest','‚ñ∂ SUIVANT'); toast('‚ñ∂ Diapo '+slideNum,'green'); }
function simAuth() { const ok=Math.random()>0.3; const sim=Math.round(ok?85+Math.random()*12:20+Math.random()*30); setEl('m-auth-sim',sim+'%'); setBar('b-auth',sim); setEl('m-auth-stat',ok?'ACC√àS AUTORIS√â':'ACC√àS REFUS√â'); showAlert('a-auth-ok',ok); showAlert('a-auth-no',!ok); setTimeout(()=>{showAlert('a-auth-ok',false);showAlert('a-auth-no',false);},3000); toast(ok?'‚úì AUTH OK!':'‚úó AUTH REFUS√âE', ok?'green':'pink'); }
function simAttendance() { setEl('m-faces-count','3'); setEl('m-att-id','3'); setEl('m-att-stat','PR√âSENCE OK ‚úì'); toast('üìã 3 personnes identifi√©es','green'); }
function simARGame() { let s=0; const t=setInterval(()=>{s+=Math.floor(Math.random()*50+10); setEl('m-game-score',s); setEl('m-caught',Math.floor(s/30));},500); setTimeout(()=>clearInterval(t),5000); toast('üëæ Jeu d√©marr√©!','green'); }

function addRep() { repCount++; setEl('m-reps',repCount); const el=document.getElementById('m-reps'); el?.classList.add('bump'); setTimeout(()=>el?.classList.remove('bump'),250); if(repCount%10===0){setCount++;setEl('m-sets',setCount);toast('üèÜ S√âRIE '+setCount+'!','green');} }
function resetReps() { repCount=0;setCount=0;setEl('m-reps',0);setEl('m-sets',0);toast('‚Ü∫ R√©initialis√©'); }
function setEx(name) { exName=name; setEl('m-ex-name',name); repCount=0; repPhase='up'; setEl('m-reps',0); toast('EXERCICE: '+name); }

function nextARItem() { arItemIdx=(arItemIdx+1)%arItems.length; const item=arItems[arItemIdx]; document.getElementById('m-ar-item').textContent=item; const arEl=document.getElementById('ar-item'); if(arEl)arEl.textContent=item; toast('AR: '+item); }

let paintCol = '#00f5ff';
function setPaintColor(c) { paintCol=c; paintColor=c; document.getElementById('m-paint-color').style.background=c+' linear-gradient(90deg,'+c+','+c+')'; document.getElementById('m-paint-color').style.boxShadow='0 0 15px '+c; toast('üé® Couleur: '+c); }
function clearPaint() { const extra=document.getElementById('extra-cvs-paint'); if(extra){const ctx=extra.getContext('2d');ctx.clearRect(0,0,extra.width,extra.height);} paintPoints=[]; paintPointsCount=0; setEl('m-paint-pts',0); toast('üóë Canvas effac√©'); }

// ================================================================
// INIT
// ================================================================
window.addEventListener('load', () => {
  // Laisser 500ms pour que le <script type="module"> d√©marre
  setTimeout(async () => {
    try {
      await initMediaPipe();
    } catch(e) {
      console.warn('MediaPipe init error:', e.message);
      document.getElementById('mpStatus').textContent = 'MODE SIMULATION';
      document.getElementById('mpStatus').className = '';
      document.getElementById('mpInitMsg').innerHTML = `
        <div style="padding:14px 18px;border:1px solid rgba(255,224,0,0.3);background:rgba(255,224,0,0.03);text-align:left">
          <div style="color:var(--neon-yellow);font-size:11px;margin-bottom:10px;font-family:'Orbitron'">‚ö† MEDIAPIPE NON CHARG√â</div>
          <div style="color:var(--text-dim);font-size:10px;line-height:2;font-family:'Share Tech Mono'">
            Cause: ${e.message}<br><br>
            <span style="color:var(--neon-green)">‚úÖ Simulation IA active ‚Äî cam√©ra fonctionne</span><br>
            <span style="color:var(--neon-cyan)">üí° Pour activer l'IA r√©elle:</span><br>
            &nbsp;&nbsp;1. V√©rifiez votre connexion internet<br>
            &nbsp;&nbsp;2. Utilisez Chrome ou Edge (pas Firefox)<br>
            &nbsp;&nbsp;3. Ouvrez via <b style="color:white">localhost</b> ou <b style="color:white">HTTPS</b><br>
            &nbsp;&nbsp;&nbsp;&nbsp;‚Üí Dans le dossier du fichier, lancez:<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span style="color:var(--neon-pink);font-size:11px">npx serve .</span> <span style="opacity:0.5">(Node.js requis)</span><br>
            &nbsp;&nbsp;&nbsp;&nbsp;ou: <span style="color:var(--neon-pink);font-size:11px">python -m http.server</span>
          </div>
        </div>`;
      document.getElementById('loadStatus').textContent = 'Simulation active';
      document.getElementById('loadBar').style.width = '100%';
      setTimeout(() => document.getElementById('loadingOverlay').classList.add('hidden'), 1500);
    }
  }, 500);
});
</script>
</body>
</html>
